import{_ as k,C as E,c as r,o as a,R as n,b as l,w as i,a as p,G as h,a1 as e}from"./chunks/framework.Dxoqk0BT.js";const C=JSON.parse('{"title":"基于 MCP 的智能 API 文档查询服务开发实践","description":"","frontmatter":{},"headers":[],"relativePath":"ai/7.md","filePath":"ai/7.md"}'),d={name:"ai/7.md"};function o(g,s,A,F,c,B){const t=E("Mermaid");return a(),r("div",null,[s[13]||(s[13]=n('<h1 id="基于-mcp-的智能-api-文档查询服务开发实践" tabindex="-1">基于 MCP 的智能 API 文档查询服务开发实践 <a class="header-anchor" href="#基于-mcp-的智能-api-文档查询服务开发实践" aria-label="Permalink to &quot;基于 MCP 的智能 API 文档查询服务开发实践&quot;">​</a></h1><h2 id="一、服务概述" tabindex="-1">一、服务概述 <a class="header-anchor" href="#一、服务概述" aria-label="Permalink to &quot;一、服务概述&quot;">​</a></h2><h3 id="_1-1-背景与痛点" tabindex="-1">1.1 背景与痛点 <a class="header-anchor" href="#_1-1-背景与痛点" aria-label="Permalink to &quot;1.1 背景与痛点&quot;">​</a></h3><p>在现代前端开发中，我们经常面临这样的场景：</p><ul><li><strong>AI 无法访问内网</strong>：YApi 等文档平台部署在内网，AI 助手无法直接访问</li><li><strong>文档查询繁琐</strong>：需要频繁切换到 YApi 平台查找接口定义，打断开发思路</li><li><strong>新人上手成本高</strong>：需要熟悉大量接口文档才能开始工作</li></ul><h3 id="_1-2-解决方案" tabindex="-1">1.2 解决方案 <a class="header-anchor" href="#_1-2-解决方案" aria-label="Permalink to &quot;1.2 解决方案&quot;">​</a></h3><p>本项目实现了一个基于 <strong>MCP (Model Context Protocol)</strong> 的 API 文档查询服务，作为 AI 助手访问内网 YApi 的桥梁，让 AI 能够按需获取和理解后端接口文档。</p><p><strong>MCP</strong> 是由 Anthropic 推出的开放协议，旨在让 AI 模型能够安全地访问外部数据源和工具。通过 MCP，AI 助手可以：</p><ul><li>突破内网限制，访问 YApi 文档</li><li>按需查询最新的 API 文档</li><li>理解接口的请求参数、响应结构</li><li>自动生成接口调用代码</li></ul><h3 id="_1-3-核心价值" tabindex="-1">1.3 核心价值 <a class="header-anchor" href="#_1-3-核心价值" aria-label="Permalink to &quot;1.3 核心价值&quot;">​</a></h3>',10)),(a(),l(e,null,{default:i(()=>[h(t,{id:"mermaid-63",class:"mermaid",graph:"graph%20LR%0A%20%20%20%20A%5B%E5%BC%80%E5%8F%91%E8%80%85%5D%20--%3E%7C%E6%8F%90%E5%87%BA%E9%9C%80%E6%B1%82%7C%20B%5BAI%20%E5%8A%A9%E6%89%8B%5D%0A%20%20%20%20B%20--%3E%7C%E6%9F%A5%E8%AF%A2%7C%20C%5BMCP%20Server%3Cbr%2F%3E%E5%86%85%E7%BD%91%E4%BB%A3%E7%90%86%5D%0A%20%20%20%20C%20--%3E%7C%E7%99%BB%E5%BD%95%E8%AE%A4%E8%AF%81%7C%20D%5B%E5%86%85%E7%BD%91%20YApi%5D%0A%20%20%20%20D%20--%3E%7C%E8%BF%94%E5%9B%9E%E6%96%87%E6%A1%A3%7C%20C%0A%20%20%20%20C%20--%3E%7C%E6%A0%BC%E5%BC%8F%E5%8C%96%E8%BF%94%E5%9B%9E%7C%20B%0A%20%20%20%20B%20--%3E%7C%E7%94%9F%E6%88%90%E4%BB%A3%E7%A0%81%7C%20E%5B%E6%8E%A5%E5%8F%A3%E8%B0%83%E7%94%A8%E4%BB%A3%E7%A0%81%5D%0A%20%20%20%20E%20--%3E%7C%E6%8F%90%E4%BE%9B%E7%BB%99%7C%20A%0A%0A%20%20%20%20style%20C%20fill%3A%234CAF50%2Ccolor%3A%23fff%0A%20%20%20%20style%20D%20fill%3A%23FF9800%2Ccolor%3A%23fff%0A"})]),fallback:i(()=>[...s[0]||(s[0]=[p(" Loading... ",-1)])]),_:1})),s[14]||(s[14]=n('<p>通过这个服务，开发者只需要告诉 AI：&quot;帮我实现这个接口&quot;，AI 就能自动：</p><ol><li>通过 MCP Server 访问内网 YApi</li><li>查询接口文档获取完整定义</li><li>理解请求参数和响应结构</li><li>生成接口调用代码</li></ol><h2 id="二、系统架构" tabindex="-1">二、系统架构 <a class="header-anchor" href="#二、系统架构" aria-label="Permalink to &quot;二、系统架构&quot;">​</a></h2><ul><li>技术栈：Python 3.12 | FastAPI | FastMCP | Docker | Nginx | SSE</li><li>开发环境：Docker | Docker Compose</li><li>文档系统：YApi（当前版本仅支持 YApi）</li><li>AI 平台：Cursor IDE</li><li>协议：MCP (Model Context Protocol)</li></ul><h3 id="_2-1-整体架构" tabindex="-1">2.1 整体架构 <a class="header-anchor" href="#_2-1-整体架构" aria-label="Permalink to &quot;2.1 整体架构&quot;">​</a></h3><p>系统采用经典的四层架构设计，每层职责清晰，便于维护和扩展：</p>',6)),(a(),l(e,null,{default:i(()=>[h(t,{id:"mermaid-125",class:"mermaid",graph:"graph%20TB%0A%20%20%20%20subgraph%20%22%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%B1%82%22%0A%20%20%20%20%20%20%20%20A%5BCursor%20IDE%5D%0A%20%20%20%20%20%20%20%20B%5Bmcp.json%20%E9%85%8D%E7%BD%AE%5D%0A%20%20%20%20end%0A%0A%20%20%20%20subgraph%20%22%E7%BD%91%E7%BB%9C%E5%B1%82%22%0A%20%20%20%20%20%20%20%20C%5BNginx%20%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86%5D%0A%20%20%20%20end%0A%0A%20%20%20%20subgraph%20%22%E5%BA%94%E7%94%A8%E5%B1%82%22%0A%20%20%20%20%20%20%20%20D%5BFastAPI%20%E5%BA%94%E7%94%A8%5D%0A%20%20%20%20%20%20%20%20E%5BAuthMiddleware%5D%0A%20%20%20%20%20%20%20%20F%5BFastMCP%20SSE%20%E7%AB%AF%E7%82%B9%5D%0A%20%20%20%20%20%20%20%20G%5BSession%20%E7%BC%93%E5%AD%98%5D%0A%20%20%20%20end%0A%0A%20%20%20%20subgraph%20%22%E6%95%B0%E6%8D%AE%E5%B1%82%22%0A%20%20%20%20%20%20%20%20H%5BYApi%20%E6%9C%8D%E5%8A%A1%5D%0A%20%20%20%20end%0A%0A%20%20%20%20A%20--%3E%7CSSE%20%E8%BF%9E%E6%8E%A5%7C%20B%0A%20%20%20%20B%20--%3E%7CHTTPS%7C%20C%0A%20%20%20%20C%20--%3E%7CHTTP%7C%20D%0A%20%20%20%20D%20--%3E%20E%0A%20%20%20%20E%20--%3E%20F%0A%20%20%20%20F%20--%3E%20G%0A%20%20%20%20G%20--%3E%7CAPI%20%E8%AF%B7%E6%B1%82%7C%20H%0A%0A%20%20%20%20style%20D%20fill%3A%23FF9800%2Ccolor%3A%23fff%0A%20%20%20%20style%20F%20fill%3A%234CAF50%2Ccolor%3A%23fff%0A%20%20%20%20style%20G%20fill%3A%232196F3%2Ccolor%3A%23fff%0A"})]),fallback:i(()=>[...s[1]||(s[1]=[p(" Loading... ",-1)])]),_:1})),s[15]||(s[15]=n('<p><strong>架构说明：</strong></p><ul><li><strong>客户端层</strong>：Cursor IDE 通过配置文件声明 MCP 服务端点，建立连接后自动维持会话</li><li><strong>网络层</strong>：Nginx 作为反向代理，提供 HTTPS 加密、长连接保持、CORS 处理等功能</li><li><strong>应用层</strong>：FastAPI + FastMCP 实现 MCP 协议，AuthMiddleware 负责认证和会话管理</li><li><strong>数据层</strong>：YApi 作为接口文档的数据源，通过 RESTful API 提供文档查询能力</li></ul><h3 id="_2-2-技术选型" tabindex="-1">2.2 技术选型 <a class="header-anchor" href="#_2-2-技术选型" aria-label="Permalink to &quot;2.2 技术选型&quot;">​</a></h3><table><thead><tr><th>层级</th><th>技术</th><th>作用</th><th>选型理由</th></tr></thead><tbody><tr><td>通信协议</td><td>SSE (Server-Sent Events)</td><td>服务端主动推送，单向实时通信</td><td>原生 HTTP、自动重连、代理友好、满足 MCP 协议需求</td></tr><tr><td>Web 框架</td><td>FastAPI</td><td>高性能异步 Web 服务</td><td>原生异步支持、类型提示、自动文档生成</td></tr><tr><td>MCP 框架</td><td>FastMCP</td><td>MCP 协议快速实现</td><td>简化 MCP 开发、内置 SSE 支持、装饰器友好</td></tr><tr><td>容器化</td><td>Docker + Docker Compose</td><td>环境隔离与快速部署</td><td>一致性环境、一键部署、便于迁移</td></tr><tr><td>反向代理</td><td>Nginx</td><td>HTTPS 终止、长连接、负载均衡</td><td>高性能、稳定可靠、丰富的配置选项</td></tr><tr><td>HTTP 客户端</td><td>Requests + Session</td><td>HTTP 请求与会话保持</td><td>简单易用、Session 自动管理 Cookie</td></tr><tr><td>日志框架</td><td>Python logging</td><td>结构化日志记录</td><td>标准库、支持多种输出、便于调试</td></tr><tr><td>环境管理</td><td>python-dotenv</td><td>环境变量配置管理</td><td>开发/生产环境分离、敏感信息保护</td></tr></tbody></table><h2 id="三、核心技术模块" tabindex="-1">三、核心技术模块 <a class="header-anchor" href="#三、核心技术模块" aria-label="Permalink to &quot;三、核心技术模块&quot;">​</a></h2><h3 id="_3-1-认证与会话管理" tabindex="-1">3.1 认证与会话管理 <a class="header-anchor" href="#_3-1-认证与会话管理" aria-label="Permalink to &quot;3.1 认证与会话管理&quot;">​</a></h3><p>系统采用多层认证机制，确保安全性的同时保持良好的用户体验。核心解决了两个挑战：</p><ol><li><strong>多用户并发认证</strong>：不同开发者可能同时使用服务，需要隔离各自的登录状态</li><li><strong>长连接会话保持</strong>：SSE 连接和消息请求是分离的，需要关联它们的认证上下文</li></ol><h4 id="认证流程设计" tabindex="-1">认证流程设计 <a class="header-anchor" href="#认证流程设计" aria-label="Permalink to &quot;认证流程设计&quot;">​</a></h4>',9)),(a(),l(e,null,{default:i(()=>[h(t,{id:"mermaid-310",class:"mermaid",graph:"sequenceDiagram%0A%20%20%20%20participant%20C%20as%20Cursor%0A%20%20%20%20participant%20N%20as%20Nginx%0A%20%20%20%20participant%20M%20as%20MCP%20Server%0A%20%20%20%20participant%20Y%20as%20YApi%0A%0A%20%20%20%20Note%20over%20C%2CY%3A%20SSE%20%E8%BF%9E%E6%8E%A5%E5%BB%BA%E7%AB%8B%0A%20%20%20%20C-%3E%3EN%3A%20GET%20%2Fmcp%2Fsse%3Cbr%2F%3EHeaders%3A%20username%2C%20password%0A%20%20%20%20N-%3E%3EM%3A%20%E8%BD%AC%E5%8F%91%E8%AF%B7%E6%B1%82%0A%20%20%20%20M-%3E%3EM%3A%20%E6%8F%90%E5%8F%96%E8%AE%A4%E8%AF%81%E4%BF%A1%E6%81%AF%3Cbr%2F%3E%E5%AD%98%E5%85%A5%20ContextVar%0A%20%20%20%20M-%3E%3EY%3A%20POST%20%2Fapi%2Fuser%2Flogin%0A%20%20%20%20Y--%3E%3EM%3A%20%E8%BF%94%E5%9B%9E%20Session%20Cookie%0A%20%20%20%20M-%3E%3EM%3A%20%E7%BC%93%E5%AD%98%20Session%3Cbr%2F%3E%E8%AE%BE%E7%BD%AE%E8%BF%87%E6%9C%9F%E6%97%B6%E9%97%B4%0A%20%20%20%20M--%3E%3EC%3A%20SSE%20%E8%BF%9E%E6%8E%A5%E5%B0%B1%E7%BB%AA%0A%0A%20%20%20%20Note%20over%20C%2CY%3A%20%E5%B7%A5%E5%85%B7%E8%B0%83%E7%94%A8%0A%20%20%20%20C-%3E%3EN%3A%20POST%20%2Fmcp%2Fmessages%2F%7Bsession_id%7D%3Cbr%2F%3EHeader%3A%20username%20(%E9%A6%96%E6%AC%A1)%0A%20%20%20%20N-%3E%3EM%3A%20%E8%BD%AC%E5%8F%91%E8%AF%B7%E6%B1%82%0A%20%20%20%20M-%3E%3EM%3A%20%E5%BB%BA%E7%AB%8B%20session_id%20%E2%86%92%20username%20%E6%98%A0%E5%B0%84%0A%20%20%20%20M-%3E%3EM%3A%20%E4%BB%8E%E7%BC%93%E5%AD%98%E8%8E%B7%E5%8F%96%20Session%0A%20%20%20%20M-%3E%3EY%3A%20GET%20%2Fapi%2Finterface%2Fget%3Fid%3Dxxx%3Cbr%2F%3E%E6%90%BA%E5%B8%A6%20Session%20Cookie%0A%20%20%20%20Y--%3E%3EM%3A%20%E8%BF%94%E5%9B%9E%E6%8E%A5%E5%8F%A3%E6%96%87%E6%A1%A3%0A%20%20%20%20M--%3E%3EC%3A%20%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%90%8E%E8%BF%94%E5%9B%9E%0A%0A%20%20%20%20Note%20over%20C%2CY%3A%20%E4%BC%9A%E8%AF%9D%E8%BF%87%E6%9C%9F%E5%A4%84%E7%90%86%0A%20%20%20%20C-%3E%3EM%3A%20%E8%AF%B7%E6%B1%82%E6%96%87%E6%A1%A3%0A%20%20%20%20M-%3E%3EY%3A%20%E4%BD%BF%E7%94%A8%E7%BC%93%E5%AD%98%20Session%0A%20%20%20%20Y--%3E%3EM%3A%20401%20Unauthorized%0A%20%20%20%20M-%3E%3EM%3A%20%E6%A3%80%E6%B5%8B%E5%88%B0%E8%BF%87%E6%9C%9F%EF%BC%8C%E6%B8%85%E9%99%A4%E7%BC%93%E5%AD%98%0A%20%20%20%20M-%3E%3EY%3A%20%E9%87%8D%E6%96%B0%E7%99%BB%E5%BD%95%0A%20%20%20%20Y--%3E%3EM%3A%20%E6%96%B0%20Session%0A%20%20%20%20M-%3E%3EY%3A%20%E9%87%8D%E8%AF%95%E8%AF%B7%E6%B1%82%0A%20%20%20%20Y--%3E%3EM%3A%20%E8%BF%94%E5%9B%9E%E6%95%B0%E6%8D%AE%0A%20%20%20%20M--%3E%3EC%3A%20%E6%AD%A3%E5%B8%B8%E5%93%8D%E5%BA%94%0A"})]),fallback:i(()=>[...s[2]||(s[2]=[p(" Loading... ",-1)])]),_:1})),s[16]||(s[16]=n(`<h4 id="核心实现要点" tabindex="-1">核心实现要点 <a class="header-anchor" href="#核心实现要点" aria-label="Permalink to &quot;核心实现要点&quot;">​</a></h4><h4 id="_1-contextvar-跨协程共享认证信息" tabindex="-1">1. ContextVar 跨协程共享认证信息 <a class="header-anchor" href="#_1-contextvar-跨协程共享认证信息" aria-label="Permalink to &quot;1. ContextVar 跨协程共享认证信息&quot;">​</a></h4><div class="language-python vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">current_request_auth: ContextVar[Dict[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">str</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, Optional[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">str</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]]] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ContextVar(</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &#39;current_request_auth&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    default</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;username&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">None</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;password&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">None</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><p><strong>为什么使用 ContextVar？</strong></p><p>在异步 Web 应用中，多个请求可能并发处理。如果使用全局变量存储认证信息，会导致数据混乱：</p><ul><li><strong>全局变量</strong>：用户 A 的认证信息可能被用户 B 覆盖</li><li><strong>线程局部存储（threading.local）</strong>：在异步环境中不适用，因为多个请求可能在同一线程中处理</li><li><strong>ContextVar</strong>：为每个异步任务（协程）提供独立的上下文，天然支持异步并发</li></ul><p><code>ContextVar</code> 会在每个请求的整个处理链中自动传递，无需手动传参，同时保证不同请求之间的隔离。</p><h4 id="_2-session-缓存设计" tabindex="-1">2. Session 缓存设计 <a class="header-anchor" href="#_2-session-缓存设计" aria-label="Permalink to &quot;2. Session 缓存设计&quot;">​</a></h4><p>Session 缓存是系统性能优化的核心，避免频繁登录造成的性能问题和被限流风险。</p>`,9)),(a(),l(e,null,{default:i(()=>[h(t,{id:"mermaid-350",class:"mermaid",graph:"graph%20LR%0A%20%20%20%20A%5B%E8%AF%B7%E6%B1%82%E5%88%B0%E8%BE%BE%5D%20--%3E%20B%7B%E7%BC%93%E5%AD%98%E5%AD%98%E5%9C%A8%3F%7D%0A%20%20%20%20B%20--%3E%7C%E6%98%AF%7C%20C%7B%E6%9C%AA%E8%BF%87%E6%9C%9F%3F%7D%0A%20%20%20%20B%20--%3E%7C%E5%90%A6%7C%20D%5B%E6%89%A7%E8%A1%8C%E7%99%BB%E5%BD%95%5D%0A%20%20%20%20C%20--%3E%7C%E6%98%AF%7C%20E%5B%E4%BD%BF%E7%94%A8%E7%BC%93%E5%AD%98%5D%0A%20%20%20%20C%20--%3E%7C%E5%90%A6%7C%20D%0A%20%20%20%20D%20--%3E%20F%5B%E7%BC%93%E5%AD%98%E6%96%B0%20Session%5D%0A%20%20%20%20F%20--%3E%20E%0A%20%20%20%20E%20--%3E%20G%5B%E6%89%A7%E8%A1%8C%E4%B8%9A%E5%8A%A1%E9%80%BB%E8%BE%91%5D%0A%20%20%20%20G%20--%3E%20H%7B401%2F403%3F%7D%0A%20%20%20%20H%20--%3E%7C%E6%98%AF%7C%20I%5B%E5%88%B7%E6%96%B0%20Session%5D%0A%20%20%20%20H%20--%3E%7C%E5%90%A6%7C%20J%5B%E8%BF%94%E5%9B%9E%E7%BB%93%E6%9E%9C%5D%0A%20%20%20%20I%20--%3E%20D%0A"})]),fallback:i(()=>[...s[3]||(s[3]=[p(" Loading... ",-1)])]),_:1})),s[17]||(s[17]=n(`<p><strong>缓存策略细节：</strong></p><ul><li><strong>时间过期检测</strong>：每次获取 Session 时检查 <code>time.time() - timestamp &gt; SESSION_EXPIRE_TIME</code></li><li><strong>状态过期检测</strong>：请求返回 401/403 时自动触发刷新</li><li><strong>线程安全</strong>：使用 <code>threading.Lock</code> 保护缓存字典的读写操作</li><li><strong>自动清理</strong>：过期的 Session 在检测时自动从缓存中移除</li></ul><p><strong>性能收益：</strong></p><p>假设 30 天过期时间，每天查询 50 次文档：</p><ul><li>传统方案：50 次登录 × 30 天 = 1500 次登录请求</li><li>缓存方案：1 次登录 + 50 次查询 × 30 天 = 仅 1 次登录</li></ul><p>登录请求减少 <strong>99.93%</strong>，同时避免了被接口限流的风险。</p><h4 id="_3-会话映射机制" tabindex="-1">3. 会话映射机制 <a class="header-anchor" href="#_3-会话映射机制" aria-label="Permalink to &quot;3. 会话映射机制&quot;">​</a></h4><p>MCP 协议中，SSE 连接建立后，后续的工具调用通过独立的 HTTP POST 请求发送到 <code>/mcp/messages/{session_id}</code>。这就带来一个问题：如何让消息请求知道是哪个用户发起的？</p><p>系统通过 <code>session_id → username</code> 映射解决这个问题：</p><div class="language-python vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">session_username_mapping: Dict[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">str</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">str</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># SSE 连接时：提供 username + password，建立初始认证</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 消息请求时：</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#   - 首次：提供 username，建立映射 session_id → username</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#   - 后续：仅需 session_id，从映射中获取 username</span></span></code></pre></div><p><strong>映射生命周期：</strong></p><ol><li><strong>建立</strong>：首次 <code>/mcp/messages/{session_id}</code> 请求时，提取 username 并建立映射</li><li><strong>使用</strong>：后续请求直接使用 <code>session_username_mapping[session_id]</code> 获取用户名</li><li><strong>清理</strong>：监听 <code>http.disconnect</code> 事件，连接断开时自动删除映射</li></ol><p>这种设计让客户端在首次请求后无需重复传递 username，减少了数据传输量，同时保持了认证的安全性。</p><h3 id="_3-2-中间件设计" tabindex="-1">3.2 中间件设计 <a class="header-anchor" href="#_3-2-中间件设计" aria-label="Permalink to &quot;3.2 中间件设计&quot;">​</a></h3><p>自定义 <code>AuthMiddleware</code> 实现细粒度的请求拦截和处理。这是整个系统安全性和可靠性的核心保障。</p><p><strong>为什么需要自定义中间件？</strong></p><p>FastAPI 的依赖注入系统在 SSE 场景下有局限性：</p><ul><li>SSE 连接建立后保持开放，依赖注入只在初始阶段执行一次</li><li>后续消息请求需要独立的认证逻辑</li><li>需要在 ASGI 层面监听连接断开事件</li></ul><p>因此，我们实现了 ASGI 中间件，在更底层控制请求处理流程。</p>`,19)),(a(),l(e,null,{default:i(()=>[h(t,{id:"mermaid-462",class:"mermaid",graph:"graph%20TB%0A%20%20%20%20A%5B%E8%AF%B7%E6%B1%82%E5%88%B0%E8%BE%BE%5D%20--%3E%20B%7B%E8%B7%AF%E5%BE%84%E5%8C%B9%E9%85%8D%20%2Fmcp%3F%7D%0A%20%20%20%20B%20--%3E%7C%E5%90%A6%7C%20C%5B%E7%9B%B4%E6%8E%A5%E8%BD%AC%E5%8F%91%5D%0A%20%20%20%20B%20--%3E%7C%E6%98%AF%7C%20D%5B%E6%8F%90%E5%8F%96%20Headers%5D%0A%20%20%20%20D%20--%3E%20E%7B%E8%B7%AF%E5%BE%84%E7%B1%BB%E5%9E%8B%3F%7D%0A%0A%20%20%20%20E%20--%3E%7C%2Fmcp%2Fsse%7C%20F%5B%E9%AA%8C%E8%AF%81%20username%20%26%20password%5D%0A%20%20%20%20E%20--%3E%7C%2Fmcp%2Fmessages%7C%20G%5B%E9%AA%8C%E8%AF%81%20session_id%5D%0A%20%20%20%20E%20--%3E%7C%E5%85%B6%E4%BB%96%7C%20C%0A%0A%20%20%20%20F%20--%3E%20H%7B%E8%AE%A4%E8%AF%81%E6%88%90%E5%8A%9F%3F%7D%0A%20%20%20%20H%20--%3E%7C%E5%90%A6%7C%20I%5B%E8%BF%94%E5%9B%9E%20401%20%E9%94%99%E8%AF%AF%5D%0A%20%20%20%20H%20--%3E%7C%E6%98%AF%7C%20J%5B%E6%89%A7%E8%A1%8C%E7%99%BB%E5%BD%95%5D%0A%20%20%20%20J%20--%3E%20K%5B%E8%AE%BE%E7%BD%AE%20ContextVar%5D%0A%0A%20%20%20%20G%20--%3E%20L%7Bsession_id%20%E5%AD%98%E5%9C%A8%3F%7D%0A%20%20%20%20L%20--%3E%7C%E5%90%A6%7C%20M%7B%E6%9C%89%20username%3F%7D%0A%20%20%20%20L%20--%3E%7C%E6%98%AF%7C%20N%5B%E4%BB%8E%E6%98%A0%E5%B0%84%E8%8E%B7%E5%8F%96%20username%5D%0A%20%20%20%20M%20--%3E%7C%E5%90%A6%7C%20I%0A%20%20%20%20M%20--%3E%7C%E6%98%AF%7C%20O%5B%E5%BB%BA%E7%AB%8B%E6%98%A0%E5%B0%84%5D%0A%0A%20%20%20%20N%20--%3E%20K%0A%20%20%20%20O%20--%3E%20K%0A%20%20%20%20K%20--%3E%20P%5B%E5%8C%85%E8%A3%85%20receive%20%E5%87%BD%E6%95%B0%5D%0A%20%20%20%20P%20--%3E%20Q%5B%E7%9B%91%E5%90%AC%E6%96%AD%E5%BC%80%E4%BA%8B%E4%BB%B6%5D%0A%20%20%20%20Q%20--%3E%20R%5B%E8%B0%83%E7%94%A8%E4%B8%8B%E6%B8%B8%E5%BA%94%E7%94%A8%5D%0A%20%20%20%20R%20--%3E%20S%7B%E8%BF%9E%E6%8E%A5%E6%96%AD%E5%BC%80%3F%7D%0A%20%20%20%20S%20--%3E%7C%E6%98%AF%7C%20T%5B%E6%B8%85%E7%90%86%E6%98%A0%E5%B0%84%5D%0A%20%20%20%20S%20--%3E%7C%E5%90%A6%7C%20U%5B%E8%BF%94%E5%9B%9E%E5%93%8D%E5%BA%94%5D%0A"})]),fallback:i(()=>[...s[4]||(s[4]=[p(" Loading... ",-1)])]),_:1})),s[18]||(s[18]=n(`<h4 id="_1-异步连接监听" tabindex="-1">1. 异步连接监听 <a class="header-anchor" href="#_1-异步连接监听" aria-label="Permalink to &quot;1. 异步连接监听&quot;">​</a></h4><p>传统的请求-响应模式下，请求结束即释放资源。但 SSE 是长连接，如何知道客户端断开了？</p><div class="language-python vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">async</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> wrapped_receive</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">():</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    message </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> receive()</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> message.get(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;type&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;http.disconnect&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        # 客户端断开，清理 session_id 映射</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        cleanup_session(session_id)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> message</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 用包装后的 receive 替换原始的</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">await</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> self</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.app(scope, wrapped_receive, send)</span></span></code></pre></div><p>通过包装 ASGI 的 <code>receive</code> 函数，我们能够监听 <code>http.disconnect</code> 事件，在客户端断开时立即清理资源，避免内存泄漏。</p><h4 id="_2-灵活的认证策略" tabindex="-1">2. 灵活的认证策略 <a class="header-anchor" href="#_2-灵活的认证策略" aria-label="Permalink to &quot;2. 灵活的认证策略&quot;">​</a></h4><p>不同端点有不同的认证需求：</p><table><thead><tr><th>端点</th><th>认证要求</th><th>原因</th></tr></thead><tbody><tr><td><code>/mcp/sse</code></td><td>username + password</td><td>初始连接，需要完整认证并登录</td></tr><tr><td><code>/mcp/messages</code> (首次)</td><td>session_id + username</td><td>建立会话映射</td></tr><tr><td><code>/mcp/messages</code> (后续)</td><td>仅 session_id</td><td>从映射获取用户，减少传输</td></tr><tr><td><code>/mcp/health</code></td><td>无需认证</td><td>健康检查应该始终可访问</td></tr></tbody></table><p>这种分层认证既保证了安全性，又优化了性能和用户体验。</p><h4 id="_3-详细的日志追踪" tabindex="-1">3. 详细的日志追踪 <a class="header-anchor" href="#_3-详细的日志追踪" aria-label="Permalink to &quot;3. 详细的日志追踪&quot;">​</a></h4><p>每个关键步骤都有结构化日志：</p><ul><li><strong>INFO</strong>：正常流程（连接建立、Session 缓存命中、文档获取成功）</li><li><strong>WARNING</strong>：可恢复异常（Session 过期、自动重登）</li><li><strong>ERROR</strong>：严重错误（认证失败、接口异常）</li></ul><p>日志包含用户名、session_id、客户端 IP 等上下文信息，便于追踪问题和性能分析。</p><h3 id="_3-3-数据处理流水线" tabindex="-1">3.3 数据处理流水线 <a class="header-anchor" href="#_3-3-数据处理流水线" aria-label="Permalink to &quot;3.3 数据处理流水线&quot;">​</a></h3><p>从用户输入 URL 到返回格式化文档，系统经历了一系列智能化的数据处理步骤。</p>`,14)),(a(),l(e,null,{default:i(()=>[h(t,{id:"mermaid-575",class:"mermaid",graph:"graph%20LR%0A%20%20%20%20A%5BURL%20%E8%BE%93%E5%85%A5%5D%20--%3E%20B%5BURL%20%E6%A0%87%E5%87%86%E5%8C%96%5D%0A%20%20%20%20B%20--%3E%20C%5B%E4%BC%9A%E8%AF%9D%E8%8E%B7%E5%8F%96%2F%E7%99%BB%E5%BD%95%5D%0A%20%20%20%20C%20--%3E%20D%5BHTTP%20%E8%AF%B7%E6%B1%82%5D%0A%20%20%20%20D%20--%3E%20E%7B%E5%93%8D%E5%BA%94%E7%A0%81%3F%7D%0A%20%20%20%20E%20--%3E%7C401%2F403%7C%20F%5B%E5%88%B7%E6%96%B0%E4%BC%9A%E8%AF%9D%5D%0A%20%20%20%20E%20--%3E%7C200%7C%20G%5BJSON%20%E8%A7%A3%E6%9E%90%5D%0A%20%20%20%20F%20--%3E%20D%0A%20%20%20%20G%20--%3E%20H%5B%E6%8F%90%E5%8F%96%E5%85%B3%E9%94%AE%E5%AD%97%E6%AE%B5%5D%0A%20%20%20%20H%20--%3E%20I%5BSchema%20%E7%BE%8E%E5%8C%96%5D%0A%20%20%20%20I%20--%3E%20J%5BMarkdown%20%E7%94%9F%E6%88%90%5D%0A%20%20%20%20J%20--%3E%20K%5B%E8%BF%94%E5%9B%9E%20AI%5D%0A%0A%20%20%20%20style%20C%20fill%3A%234CAF50%2Ccolor%3A%23fff%0A"})]),fallback:i(()=>[...s[5]||(s[5]=[p(" Loading... ",-1)])]),_:1})),s[19]||(s[19]=n(`<h4 id="_1-url-自动转换" tabindex="-1">1. URL 自动转换 <a class="header-anchor" href="#_1-url-自动转换" aria-label="Permalink to &quot;1. URL 自动转换&quot;">​</a></h4><p>YApi 的页面 URL 和 API URL 格式不同，系统智能识别并转换：</p><div class="language-python vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> convert_to_api_url</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(page_url: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">str</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) -&gt; </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">str</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;&quot;&quot;支持页面 URL 和 API URL 两种输入格式&quot;&quot;&quot;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # 输入：http://domain.com/project/123</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # 输出：http://domain.com/api/interface/get?id=123</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # 输入：http://domain.com/api/interface/get?id=123</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # 输出：原样返回（已经是 API URL）</span></span></code></pre></div><p>开发者通常复制的是 YApi 页面 URL，系统自动识别并转换为 API URL，避免手动转换的繁琐和错误。</p><h4 id="_2-json-schema-美化" tabindex="-1">2. JSON Schema 美化 <a class="header-anchor" href="#_2-json-schema-美化" aria-label="Permalink to &quot;2. JSON Schema 美化&quot;">​</a></h4><p>YApi 返回的请求体和响应体是 JSON 字符串，直接展示不易阅读：</p><div class="language-python vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> parse_json_schema</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(schema_str: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">str</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) -&gt; </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">str</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;&quot;&quot;解析并美化 JSON Schema&quot;&quot;&quot;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    try</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        schema </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> json.loads(schema_str)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> json.dumps(schema, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">indent</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">ensure_ascii</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">False</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    except</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (json.JSONDecodeError, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">TypeError</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">):</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> schema_str  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 解析失败时返回原始字符串</span></span></code></pre></div><h4 id="_3-批量查询支持" tabindex="-1">3. 批量查询支持 <a class="header-anchor" href="#_3-批量查询支持" aria-label="Permalink to &quot;3. 批量查询支持&quot;">​</a></h4><p>AI 可以一次性查询多个接口文档：</p><div class="language-python vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">async</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> fetch_api_docs</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(url: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">str</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> list[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">str</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]) -&gt; </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">str</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;&quot;&quot;支持单个 URL 或 URL 列表&quot;&quot;&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    urls </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> url </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">if</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> isinstance</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(url, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">list</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">else</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [url]</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # 批量获取并合并结果</span></span></code></pre></div><h3 id="_3-4-错误处理与重试" tabindex="-1">3.4 错误处理与重试 <a class="header-anchor" href="#_3-4-错误处理与重试" aria-label="Permalink to &quot;3.4 错误处理与重试&quot;">​</a></h3><p>系统设计了完善的错误处理和自动重试机制，确保高可用性和良好的用户体验。</p>`,12)),(a(),l(e,null,{default:i(()=>[h(t,{id:"mermaid-606",class:"mermaid",graph:"stateDiagram-v2%0A%20%20%20%20%5B*%5D%20--%3E%20%E5%8F%91%E8%B5%B7%E8%AF%B7%E6%B1%82%0A%20%20%20%20%E5%8F%91%E8%B5%B7%E8%AF%B7%E6%B1%82%20--%3E%20%E4%BD%BF%E7%94%A8%E7%BC%93%E5%AD%98Session%0A%20%20%20%20%E4%BD%BF%E7%94%A8%E7%BC%93%E5%AD%98Session%20--%3E%20%E8%AF%B7%E6%B1%82%E6%88%90%E5%8A%9F%3A%20200%20OK%0A%20%20%20%20%E4%BD%BF%E7%94%A8%E7%BC%93%E5%AD%98Session%20--%3E%20Session%E8%BF%87%E6%9C%9F%3A%20errcode%20!%3D%200%0A%20%20%20%20%E4%BD%BF%E7%94%A8%E7%BC%93%E5%AD%98Session%20--%3E%20HTTP%E9%94%99%E8%AF%AF%3A%20401%2F403%0A%0A%20%20%20%20Session%E8%BF%87%E6%9C%9F%20--%3E%20%E5%88%B7%E6%96%B0Session%0A%20%20%20%20HTTP%E9%94%99%E8%AF%AF%20--%3E%20%E5%88%B7%E6%96%B0Session%0A%20%20%20%20%E5%88%B7%E6%96%B0Session%20--%3E%20%E6%B8%85%E9%99%A4%E7%BC%93%E5%AD%98%0A%20%20%20%20%E6%B8%85%E9%99%A4%E7%BC%93%E5%AD%98%20--%3E%20%E9%87%8D%E6%96%B0%E7%99%BB%E5%BD%95%0A%20%20%20%20%E9%87%8D%E6%96%B0%E7%99%BB%E5%BD%95%20--%3E%20%E6%9B%B4%E6%96%B0%E7%BC%93%E5%AD%98%0A%20%20%20%20%E6%9B%B4%E6%96%B0%E7%BC%93%E5%AD%98%20--%3E%20%E9%87%8D%E8%AF%95%E8%AF%B7%E6%B1%82%0A%20%20%20%20%E9%87%8D%E8%AF%95%E8%AF%B7%E6%B1%82%20--%3E%20%E8%AF%B7%E6%B1%82%E6%88%90%E5%8A%9F%0A%20%20%20%20%E9%87%8D%E8%AF%95%E8%AF%B7%E6%B1%82%20--%3E%20%E6%9C%80%E7%BB%88%E5%A4%B1%E8%B4%A5%3A%20%E4%BB%8D%E7%84%B6%E5%A4%B1%E8%B4%A5%0A%0A%20%20%20%20%E8%AF%B7%E6%B1%82%E6%88%90%E5%8A%9F%20--%3E%20%5B*%5D%0A%20%20%20%20%E6%9C%80%E7%BB%88%E5%A4%B1%E8%B4%A5%20--%3E%20%5B*%5D%0A"})]),fallback:i(()=>[...s[6]||(s[6]=[p(" Loading... ",-1)])]),_:1})),s[20]||(s[20]=n(`<p><strong>重试策略：</strong></p><p>系统通过两层检测机制（业务层 errcode 和 HTTP 状态码）自动识别 Session 过期，并自动刷新重试，用户完全无感知。</p><p><strong>容错边界：</strong></p><table><thead><tr><th>错误类型</th><th>处理方式</th><th>用户影响</th></tr></thead><tbody><tr><td>Session 过期</td><td>自动刷新并重试</td><td>零感知</td></tr><tr><td>网络临时故障</td><td>抛出异常，显示错误信息</td><td>看到错误提示</td></tr><tr><td>接口不存在</td><td>返回友好错误信息</td><td>看到错误提示</td></tr><tr><td>YApi 服务不可用</td><td>抛出异常</td><td>看到错误提示</td></tr></tbody></table><p>只有 Session 过期这类可恢复的错误才会自动重试，其他错误直接返回，避免无意义的重试浪费资源。</p><h3 id="_3-5-通信协议选择" tabindex="-1">3.5 通信协议选择 <a class="header-anchor" href="#_3-5-通信协议选择" aria-label="Permalink to &quot;3.5 通信协议选择&quot;">​</a></h3><p><strong>为什么使用 SSE (Server-Sent Events)？</strong></p><p>MCP 协议支持多种传输方式，对比分析后选择了 SSE：</p><table><thead><tr><th>方案</th><th>优点</th><th>缺点</th><th>适用性</th></tr></thead><tbody><tr><td>HTTP 轮询</td><td>实现简单</td><td>资源浪费、延迟高</td><td>❌ 不适用</td></tr><tr><td>WebSocket</td><td>真正的双向通信、低延迟</td><td>协议复杂、代理支持差</td><td>🔶 过度设计</td></tr><tr><td>SSE</td><td>原生 HTTP、自动重连</td><td>仅支持单向推送</td><td>✅ 最佳选择</td></tr></tbody></table><p><strong>SSE 的核心优势：</strong></p><ul><li><strong>原生 HTTP</strong>：基于标准 HTTP 协议，无需特殊握手，代理友好</li><li><strong>自动重连</strong>：连接断开后浏览器自动重新连接</li><li><strong>满足需求</strong>：MCP 是&quot;请求-响应&quot;模式，不需要服务端主动推送，单向通信足够</li><li><strong>简单实现</strong>：服务端只需设置 <code>Content-Type: text/event-stream</code></li></ul><h3 id="_3-6-异步资源清理" tabindex="-1">3.6 异步资源清理 <a class="header-anchor" href="#_3-6-异步资源清理" aria-label="Permalink to &quot;3.6 异步资源清理&quot;">​</a></h3><p><strong>核心挑战：</strong> SSE 长连接可能持续数天，客户端随时可能断开，如何及时清理资源？</p><p><strong>解决方案：</strong> 包装 ASGI <code>receive</code> 函数监听断开事件</p><div class="language-python vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">async</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> wrapped_receive</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">():</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    message </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> receive()</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> message.get(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;type&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;http.disconnect&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        cleanup_session(session_id)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> message</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">await</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> self</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.app(scope, wrapped_receive, send)</span></span></code></pre></div><p>通过监听 <code>http.disconnect</code> 事件，在客户端断开时立即清理 <code>session_id → username</code> 映射，确保：</p><ul><li><strong>及时清理</strong>：连接断开立即释放资源</li><li><strong>避免内存泄漏</strong>：映射字典不会无限增长</li><li><strong>准确追踪</strong>：日志记录活跃会话数，便于监控</li></ul><h2 id="四、部署架构" tabindex="-1">四、部署架构 <a class="header-anchor" href="#四、部署架构" aria-label="Permalink to &quot;四、部署架构&quot;">​</a></h2><h3 id="_4-1-容器化部署" tabindex="-1">4.1 容器化部署 <a class="header-anchor" href="#_4-1-容器化部署" aria-label="Permalink to &quot;4.1 容器化部署&quot;">​</a></h3><p>采用 Docker 容器化部署，实现&quot;一次构建，到处运行&quot;的目标。</p>`,20)),(a(),l(e,null,{default:i(()=>[h(t,{id:"mermaid-815",class:"mermaid",graph:"graph%20TB%0A%20%20%20%20subgraph%20%22Docker%20%E4%B8%BB%E6%9C%BA%22%0A%20%20%20%20%20%20%20%20subgraph%20%22%E5%AE%B9%E5%99%A8%3A%20api-docs-mcp-server%22%0A%20%20%20%20%20%20%20%20%20%20%20%20A%5BPython%203.12%20Slim%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20B%5BFastAPI%20%E5%BA%94%E7%94%A8%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20C%5B%E7%AB%AF%E5%8F%A3%3A%208000%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20D%5BVolume%3A%20%2Fapp%2Fstatic%5D%0A%20%20%20%20%20%20%20%20end%0A%0A%20%20%20%20%20%20%20%20E%5B%E5%AE%BF%E4%B8%BB%E6%9C%BA%E7%AB%AF%E5%8F%A3%3A%209527%5D%0A%20%20%20%20%20%20%20%20F%5B%E9%9D%99%E6%80%81%E6%96%87%E4%BB%B6%E7%9B%AE%E5%BD%95%5D%0A%20%20%20%20end%0A%0A%20%20%20%20G%5BNginx%5D%20--%3E%7C%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86%7C%20E%0A%20%20%20%20E%20--%3E%20C%0A%20%20%20%20F%20-.%E6%8C%82%E8%BD%BD.-%3E%20D%0A%0A%20%20%20%20style%20B%20fill%3A%234CAF50%2Ccolor%3A%23fff%0A%20%20%20%20style%20G%20fill%3A%232196F3%2Ccolor%3A%23fff%0A"})]),fallback:i(()=>[...s[7]||(s[7]=[p(" Loading... ",-1)])]),_:1})),s[21]||(s[21]=n(`<p><strong>容器化优势：</strong> 环境一致性、快速部署、资源隔离、易于迁移。</p><h4 id="dockerfile-设计要点" tabindex="-1">Dockerfile 设计要点 <a class="header-anchor" href="#dockerfile-设计要点" aria-label="Permalink to &quot;Dockerfile 设计要点&quot;">​</a></h4><div class="language-dockerfile vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">dockerfile</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> python:3.12-slim  # 使用精简版本，减小镜像体积</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 配置国内 pip 镜像源，加速依赖安装</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">RUN</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> pip config set global.index-url https://pypi.tuna.tsinghua.edu.cn/simple</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 分层构建：先复制 requirements.txt，利用 Docker 缓存</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">COPY</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> requirements.txt .</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">RUN</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> pip install --no-cache-dir -r requirements.txt</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 最后复制应用代码，避免代码变更导致依赖重装</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">COPY</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> api-docs-mcp-server.py .</span></span></code></pre></div><p>镜像优化：使用 slim 镜像、禁用 pip 缓存、分层构建利用缓存。</p><h4 id="docker-compose-配置要点" tabindex="-1">Docker Compose 配置要点 <a class="header-anchor" href="#docker-compose-配置要点" aria-label="Permalink to &quot;Docker Compose 配置要点&quot;">​</a></h4><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">environment</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">SESSION_EXPIRE_TIME=2592000</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> # 30天，平衡安全性和便利性</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">SERVER_HOST=0.0.0.0</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> # 监听所有网卡，允许外部访问</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">SERVER_PORT=8000</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> # 容器内端口</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">ports</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;9527:8000&#39;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> # 宿主机:容器，对外暴露 9527</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">volumes</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">./static:/app/static</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> # 挂载静态文件目录（可选）</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">healthcheck</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  test</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;CMD&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;curl&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;-f&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;http://localhost:8000/mcp/health&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  interval</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">30s</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> # 每 30 秒检查一次</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  timeout</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">10s</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> # 超时时间 10 秒</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  retries</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> # 失败 3 次后标记为 unhealthy</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">restart</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">unless-stopped</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> # 异常退出时自动重启</span></span></code></pre></div><p>健康检查确保服务高可用：连续 3 次失败自动重启容器。</p><h3 id="_4-2-nginx-配置解析" tabindex="-1">4.2 Nginx 配置解析 <a class="header-anchor" href="#_4-2-nginx-配置解析" aria-label="Permalink to &quot;4.2 Nginx 配置解析&quot;">​</a></h3><p>Nginx 作为反向代理，承担了 HTTPS 终止、长连接保持、CORS 处理等重要职责。SSE 长连接对 Nginx 配置有特殊要求。</p><div class="language-nginx vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">nginx</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">location</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> /mcp/ </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # 核心配置</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    proxy_pass </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">http://127.0.0.1:9527/mcp/;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    proxy_http_version </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">1.1;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # SSE 关键配置</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    proxy_buffering </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">off;           </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 禁用缓冲</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    proxy_cache </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">off;               </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 禁用缓存</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    chunked_transfer_encoding </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">on;  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 分块传输</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # 超长超时</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    proxy_connect_timeout </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">7d;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    proxy_send_timeout </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">7d;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    proxy_read_timeout </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">7d;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # CORS 支持</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    add_header </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Access-Control-Allow-Origin </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;*&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> always;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    add_header </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Access-Control-Allow-Methods </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;GET, POST, OPTIONS&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> always;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p><strong>为什么需要这些配置？</strong></p><table><thead><tr><th>配置项</th><th>原因</th><th>不配置的后果</th></tr></thead><tbody><tr><td><code>proxy_buffering off</code></td><td>SSE 需要实时推送，缓冲会阻塞数据流</td><td>消息延迟，甚至完全无法接收</td></tr><tr><td><code>proxy_cache off</code></td><td>禁用缓存，确保实时数据</td><td>可能缓存旧数据，导致信息不一致</td></tr><tr><td><code>7d</code> 超时</td><td>SSE 连接是长连接，需要保持数周不断开</td><td>连接频繁断开，用户体验差</td></tr><tr><td><code>chunked_transfer_encoding on</code></td><td>支持流式传输，避免等待完整响应</td><td>无法流式传输，SSE 无法工作</td></tr><tr><td><code>Connection &#39;&#39;</code></td><td>清除 Connection 头，保持连接持久化</td><td>连接可能被提前关闭</td></tr><tr><td><code>proxy_http_version 1.1</code></td><td>HTTP/1.1 才支持长连接</td><td>默认 HTTP/1.0 不支持长连接</td></tr></tbody></table><p><strong>CORS 配置说明：</strong></p><div class="language-nginx vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">nginx</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">add_header </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Access-Control-Allow-Origin </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;*&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> always;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">add_header </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Access-Control-Allow-Methods </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;GET, POST, OPTIONS&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> always;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">add_header </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Access-Control-Allow-Headers </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;Content-Type, Authorization&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> always;</span></span></code></pre></div><p>允许跨域访问，<code>always</code> 确保错误响应也携带 CORS 头（否则浏览器会报 CORS 错误而非真实错误）。</p><p><strong>性能优化配置：</strong></p><div class="language-nginx vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">nginx</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">client_max_body_size </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">10M;        </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 允许上传 10MB 大小的请求体</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">client_body_buffer_size </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">10M;     </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 缓冲区大小，避免写入临时文件</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">proxy_set_header </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">X-Real-IP $remote_addr;           </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 传递真实 IP</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">proxy_set_header </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">X-Forwarded-For $proxy_add_x_forwarded_for;  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 传递代理链</span></span></code></pre></div><h3 id="_4-3-部署流程" tabindex="-1">4.3 部署流程 <a class="header-anchor" href="#_4-3-部署流程" aria-label="Permalink to &quot;4.3 部署流程&quot;">​</a></h3>`,18)),(a(),l(e,null,{default:i(()=>[h(t,{id:"mermaid-940",class:"mermaid",graph:"graph%20LR%0A%20%20%20%20A%5B%E5%87%86%E5%A4%87%E4%BB%A3%E7%A0%81%5D%20--%3E%20B%5B%E9%85%8D%E7%BD%AE%20.env%5D%0A%20%20%20%20B%20--%3E%20C%5B%E6%9E%84%E5%BB%BA%E9%95%9C%E5%83%8F%5D%0A%20%20%20%20C%20--%3E%20D%5B%E5%90%AF%E5%8A%A8%E5%AE%B9%E5%99%A8%5D%0A%20%20%20%20D%20--%3E%20E%5B%E9%85%8D%E7%BD%AE%20Nginx%5D%0A%20%20%20%20E%20--%3E%20F%5B%E9%85%8D%E7%BD%AE%E5%AE%A2%E6%88%B7%E7%AB%AF%20mcp.json%5D%0A%20%20%20%20F%20--%3E%20G%5B%E9%AA%8C%E8%AF%81%E8%BF%9E%E6%8E%A5%5D%0A%0A%20%20%20%20style%20G%20fill%3A%234CAF50%2Ccolor%3A%23fff%0A"})]),fallback:i(()=>[...s[8]||(s[8]=[p(" Loading... ",-1)])]),_:1})),s[22]||(s[22]=n(`<p><strong>完整部署步骤：</strong></p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 步骤 1：克隆代码（如果尚未克隆）</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">git</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> clone</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">repository-ur</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">l</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">cd</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> project/tools/mcp</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 步骤 2：创建 .env 文件（可选，也可以在 docker-compose.yml 中配置）</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">cat</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> .env</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;&lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> EOF</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">API_USERNAME=your-email@example.com</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">API_PASSWORD=your-password</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">LOGIN_URL=https://yapi.your-domain.com/api/user/login</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">SESSION_EXPIRE_TIME=2592000</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">SERVER_HOST=0.0.0.0</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">SERVER_PORT=8000</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">EOF</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 步骤 3：构建并启动容器</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">docker-compose</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> up</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -d</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --build</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 步骤 4：查看启动日志</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">docker-compose</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> logs</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -f</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> api-docs-mcp</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 步骤 5：验证服务健康</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">curl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> http://localhost:9527/mcp/health</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 步骤 6：配置 Nginx（参考前文配置）</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> vim</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /etc/nginx/sites-available/your-domain.conf</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> nginx</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -t</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> systemctl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> reload</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> nginx</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 步骤 7：验证 HTTPS 访问</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">curl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> https://your-domain.com/mcp/health</span></span></code></pre></div><p><strong>常用运维命令：</strong></p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 查看容器状态</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">docker-compose</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ps</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 查看实时日志</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">docker-compose</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> logs</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -f</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 重启服务</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">docker-compose</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> restart</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 停止服务</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">docker-compose</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> down</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 更新代码后重新部署</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">git</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> pull</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">docker-compose</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> up</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -d</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --build</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 进入容器调试</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">docker-compose</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> exec</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> api-docs-mcp</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> bash</span></span></code></pre></div><h2 id="五、客户端配置" tabindex="-1">五、客户端配置 <a class="header-anchor" href="#五、客户端配置" aria-label="Permalink to &quot;五、客户端配置&quot;">​</a></h2><h3 id="_5-1-mcp-json-配置" tabindex="-1">5.1 mcp.json 配置 <a class="header-anchor" href="#_5-1-mcp-json-配置" aria-label="Permalink to &quot;5.1 mcp.json 配置&quot;">​</a></h3><p>Cursor IDE 通过 <code>~/.cursor/mcp.json</code> 文件配置 MCP 服务器连接：</p><div class="language-json vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;api-docs-server&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;comment&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;获取惠灏后端接口API文档的MCP服务&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;url&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;https://base-quake.huihaohealth.com/mcp/sse&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;headers&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      &quot;username&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;user@example.com&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      &quot;password&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;your-password&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p><strong>配置项说明：</strong></p><ul><li><code>api-docs-server</code>：服务器名称，自定义标识符</li><li><code>comment</code>：注释说明，帮助理解服务用途</li><li><code>url</code>：MCP SSE 端点地址，必须是 <code>/mcp/sse</code> 路径</li><li><code>headers</code>：认证信息，在每个请求中自动携带 <ul><li><code>username</code>：YApi 登录邮箱</li><li><code>password</code>：YApi 登录密码</li></ul></li></ul><p><strong>安全建议：</strong> 设置文件权限为 600，不要提交到版本控制，定期更换密码。</p><p><strong>多环境配置：</strong></p><p>可以配置多个 MCP 服务器：</p><div class="language-json vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;api-docs-server&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;url&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;https://prod-api-docs.example.com/mcp/sse&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;headers&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: { </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">&quot;username&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;user@example.com&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">&quot;password&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;prod-pass&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  },</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;api-docs-test&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;url&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;https://test-api-docs.example.com/mcp/sse&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;headers&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: { </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">&quot;username&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;user@example.com&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">&quot;password&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;test-pass&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>AI 会自动发现所有配置的 MCP 服务器，你可以指定使用哪一个。</p><h3 id="_5-2-使用工作流" tabindex="-1">5.2 使用工作流 <a class="header-anchor" href="#_5-2-使用工作流" aria-label="Permalink to &quot;5.2 使用工作流&quot;">​</a></h3><p>完整的用户使用流程如下：</p>`,17)),(a(),l(e,null,{default:i(()=>[h(t,{id:"mermaid-1015",class:"mermaid",graph:"sequenceDiagram%0A%20%20%20%20participant%20Dev%20as%20%E5%BC%80%E5%8F%91%E8%80%85%0A%20%20%20%20participant%20Cursor%20as%20Cursor%20IDE%0A%20%20%20%20participant%20MCP%20as%20MCP%20Server%0A%20%20%20%20participant%20AI%20as%20AI%20%E5%8A%A9%E6%89%8B%0A%0A%20%20%20%20Dev-%3E%3ECursor%3A%20%E6%89%93%E5%BC%80%20IDE%0A%20%20%20%20Cursor-%3E%3EMCP%3A%20%E5%BB%BA%E7%AB%8B%20SSE%20%E8%BF%9E%E6%8E%A5%3Cbr%2F%3E(%E8%87%AA%E5%8A%A8%E6%90%BA%E5%B8%A6%E8%AE%A4%E8%AF%81%E4%BF%A1%E6%81%AF)%0A%20%20%20%20MCP--%3E%3ECursor%3A%20%E8%BF%9E%E6%8E%A5%E6%88%90%E5%8A%9F%0A%0A%20%20%20%20Dev-%3E%3ECursor%3A%20%22%40url%20%E5%B8%AE%E6%88%91%E5%AE%9E%E7%8E%B0%E8%BF%99%E4%B8%AA%E6%8E%A5%E5%8F%A3%22%0A%20%20%20%20Cursor-%3E%3EAI%3A%20%E8%A7%A3%E6%9E%90%E9%9C%80%E6%B1%82%0A%20%20%20%20AI-%3E%3EMCP%3A%20%E8%B0%83%E7%94%A8%20fetch_api_docs(url)%0A%20%20%20%20MCP-%3E%3EMCP%3A%20%E7%99%BB%E5%BD%95%20YApi%20%E8%8E%B7%E5%8F%96%E6%96%87%E6%A1%A3%0A%20%20%20%20MCP--%3E%3EAI%3A%20%E8%BF%94%E5%9B%9E%E6%A0%BC%E5%BC%8F%E5%8C%96%E6%96%87%E6%A1%A3%0A%20%20%20%20AI-%3E%3EAI%3A%20%E6%A0%B9%E6%8D%AE%E6%96%87%E6%A1%A3%E7%94%9F%E6%88%90%E4%BB%A3%E7%A0%81%0A%20%20%20%20AI--%3E%3ECursor%3A%20%E5%B1%95%E7%A4%BA%E7%94%9F%E6%88%90%E7%9A%84%E4%BB%A3%E7%A0%81%0A%20%20%20%20Cursor--%3E%3EDev%3A%20%E8%87%AA%E5%8A%A8%E5%AE%8C%E6%88%90%0A"})]),fallback:i(()=>[...s[9]||(s[9]=[p(" Loading... ",-1)])]),_:1})),s[23]||(s[23]=n(`<p><strong>实际使用示例：</strong></p><div class="language-text vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">text</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>开发者：@https://yapi.example.com/project/interface/api/12345 帮我实现这个接口</span></span>
<span class="line"><span></span></span>
<span class="line"><span>AI：正在查询接口文档...</span></span>
<span class="line"><span>    [调用 MCP fetch_api_docs 工具]</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    我已经查询到接口文档，这是一个用户登录接口：</span></span>
<span class="line"><span>    - 请求方式：POST /api/user/login</span></span>
<span class="line"><span>    - 请求参数：email, password</span></span>
<span class="line"><span>    - 响应：包含 token 和用户信息</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    以下是实现代码：</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    /**</span></span>
<span class="line"><span>     * 用户登录</span></span>
<span class="line"><span>     * @param {Object} params - 登录参数</span></span>
<span class="line"><span>     * @param {string} params.email - 用户邮箱</span></span>
<span class="line"><span>     * @param {string} params.password - 用户密码</span></span>
<span class="line"><span>     * @returns {Promise&lt;{token: string, userInfo: object}&gt;}</span></span>
<span class="line"><span>     */</span></span>
<span class="line"><span>    export const userLogin = params =&gt; {</span></span>
<span class="line"><span>      return api.post(&#39;/api/user/login&#39;, params)</span></span>
<span class="line"><span>    }</span></span></code></pre></div><p><strong>使用技巧：</strong></p><ol><li><strong>直接粘贴 URL</strong>：从浏览器地址栏复制 YApi 页面 URL 即可，无需转换</li><li><strong>批量查询</strong>：<code>@url1 @url2 @url3 帮我实现这些接口</code></li><li><strong>追加需求</strong>：<code>需要加上 Mock 数据支持</code></li><li><strong>修改代码</strong>：<code>改用 async/await 语法</code></li></ol><h2 id="六、监控与运维" tabindex="-1">六、监控与运维 <a class="header-anchor" href="#六、监控与运维" aria-label="Permalink to &quot;六、监控与运维&quot;">​</a></h2><h3 id="_6-1-日志体系" tabindex="-1">6.1 日志体系 <a class="header-anchor" href="#_6-1-日志体系" aria-label="Permalink to &quot;6.1 日志体系&quot;">​</a></h3><p>完善的日志体系是系统可观测性的基础。系统实现了分层次、结构化的日志记录。</p>`,7)),(a(),l(e,null,{default:i(()=>[h(t,{id:"mermaid-1054",class:"mermaid",graph:"graph%20LR%0A%20%20%20%20A%5B%E8%AF%B7%E6%B1%82%E5%88%B0%E8%BE%BE%5D%20--%3E%20B%5B%E8%AE%A4%E8%AF%81%E6%97%A5%E5%BF%97%5D%0A%20%20%20%20B%20--%3E%20C%5BSession%20%E7%AE%A1%E7%90%86%E6%97%A5%E5%BF%97%5D%0A%20%20%20%20C%20--%3E%20D%5B%E4%B8%9A%E5%8A%A1%E5%A4%84%E7%90%86%E6%97%A5%E5%BF%97%5D%0A%20%20%20%20D%20--%3E%20E%5B%E9%94%99%E8%AF%AF%E6%97%A5%E5%BF%97%5D%0A%0A%20%20%20%20B%20--%3E%20F%5B%E5%AE%A2%E6%88%B7%E7%AB%AFIP%5D%0A%20%20%20%20B%20--%3E%20G%5B%E7%94%A8%E6%88%B7%E4%BF%A1%E6%81%AF%5D%0A%20%20%20%20C%20--%3E%20H%5B%E7%BC%93%E5%AD%98%E5%91%BD%E4%B8%AD%5D%0A%20%20%20%20C%20--%3E%20I%5B%E5%88%B7%E6%96%B0%E4%BA%8B%E4%BB%B6%5D%0A%20%20%20%20D%20--%3E%20J%5BURL%E8%BD%AC%E6%8D%A2%5D%0A%20%20%20%20D%20--%3E%20K%5B%E5%93%8D%E5%BA%94%E7%8A%B6%E6%80%81%5D%0A%20%20%20%20E%20--%3E%20L%5B%E5%BC%82%E5%B8%B8%E5%A0%86%E6%A0%88%5D%0A%0A%20%20%20%20style%20B%20fill%3A%232196F3%2Ccolor%3A%23fff%0A%20%20%20%20style%20E%20fill%3A%23f44336%2Ccolor%3A%23fff%0A"})]),fallback:i(()=>[...s[10]||(s[10]=[p(" Loading... ",-1)])]),_:1})),s[24]||(s[24]=n(`<p><strong>日志格式设计：</strong></p><div class="language-python vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">logging.basicConfig(</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    level</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">logging.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">INFO</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    format</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">%(asctime)s</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">] [MCP][</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">%(levelname)s</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">] </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">%(message)s</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    datefmt</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;%Y-%m-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">%d</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> %H:%M:%S&#39;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><ul><li><strong>时间戳</strong>：便于追踪问题发生时间</li><li><strong>标签 [MCP]</strong>：区分不同服务的日志</li><li><strong>日志级别</strong>：INFO/WARNING/ERROR，快速定位问题严重程度</li><li><strong>结构化信息</strong>：用户名、IP、session_id 等关键信息</li></ul><p><strong>完整日志示例：</strong></p><div class="language-text vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">text</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>[2025-11-14 10:00:00] [MCP][INFO] === SSE 连接请求 === 客户端IP: 192.168.1.100, 用户: user@example.com</span></span>
<span class="line"><span>[2025-11-14 10:00:01] [MCP][INFO] 执行登录（用户: user@example.com）</span></span>
<span class="line"><span>[2025-11-14 10:00:02] [MCP][INFO] 登录成功（用户: user@example.com）</span></span>
<span class="line"><span>[2025-11-14 10:00:02] [MCP][INFO] Session 已缓存（用户: user@example.com）</span></span>
<span class="line"><span>[2025-11-14 10:00:03] [MCP][INFO] SSE 连接已建立（用户: user@example.com）</span></span>
<span class="line"><span></span></span>
<span class="line"><span>[2025-11-14 10:01:00] [MCP][INFO] 请求路径: /mcp/messages/abc123, 用户: user@example.com, session_id: abc123</span></span>
<span class="line"><span>[2025-11-14 10:01:00] [MCP][INFO] 建立会话映射: abc123 -&gt; user@example.com</span></span>
<span class="line"><span>[2025-11-14 10:01:00] [MCP][INFO] 当前活跃会话数: 1</span></span>
<span class="line"><span>[2025-11-14 10:01:01] [MCP][INFO] 准备获取 1 个文档</span></span>
<span class="line"><span>[2025-11-14 10:01:01] [MCP][INFO] 获取文档 [1/1]: https://yapi.example.com/project/123</span></span>
<span class="line"><span>[2025-11-14 10:01:01] [MCP][INFO] URL 转换: https://yapi.example.com/project/123 -&gt; https://yapi.example.com/api/interface/get?id=123</span></span>
<span class="line"><span>[2025-11-14 10:01:01] [MCP][INFO] 使用缓存的 Session（用户: user@example.com）</span></span>
<span class="line"><span>[2025-11-14 10:01:02] [MCP][INFO] 获取数据成功，状态码: 0</span></span>
<span class="line"><span></span></span>
<span class="line"><span>[2025-11-14 10:30:00] [MCP][WARNING] Session 已失效，重新登录（用户: user@example.com）</span></span>
<span class="line"><span>[2025-11-14 10:30:01] [MCP][INFO] 登录成功（用户: user@example.com）</span></span>
<span class="line"><span>[2025-11-14 10:30:01] [MCP][INFO] Session 已缓存（用户: user@example.com）</span></span>
<span class="line"><span></span></span>
<span class="line"><span>[2025-11-14 11:00:00] [MCP][INFO] === 连接断开 === 路径: /mcp/sse, session_id: abc123</span></span>
<span class="line"><span>[2025-11-14 11:00:00] [MCP][INFO] 清理会话映射: abc123 (用户: user@example.com)</span></span>
<span class="line"><span>[2025-11-14 11:00:00] [MCP][INFO] 当前活跃会话数: 0</span></span></code></pre></div><p><strong>日志分析价值：</strong></p><p>通过日志可以：</p><ol><li><strong>性能分析</strong>：统计接口响应时间、Session 缓存命中率</li><li><strong>用户行为</strong>：了解哪些接口被频繁查询</li><li><strong>问题定位</strong>：异常时查看完整的请求链路</li><li><strong>容量规划</strong>：分析并发用户数、请求峰值</li></ol><p><strong>日志最佳实践：</strong></p><div class="language-python vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 不好的日志：信息不足</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">logger.info(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;登录成功&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 好的日志：包含关键上下文</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">logger.info(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">f</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;登录成功（用户: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">{</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">username</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">）&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 不好的日志：敏感信息暴露</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">logger.info(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">f</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;登录：</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">{</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">username</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">{</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">password</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 好的日志：脱敏处理</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">logger.info(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">f</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;登录：</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">{</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">username</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">, 密码: ***&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><h3 id="_6-2-健康检查" tabindex="-1">6.2 健康检查 <a class="header-anchor" href="#_6-2-健康检查" aria-label="Permalink to &quot;6.2 健康检查&quot;">​</a></h3><p>Docker Compose 配置了自动健康检查，确保服务异常时能自动恢复。</p>`,12)),(a(),l(e,null,{default:i(()=>[h(t,{id:"mermaid-1123",class:"mermaid",graph:"graph%20TB%0A%20%20%20%20A%5BDocker%20Healthcheck%5D%20--%3E%7C30%E7%A7%92%E9%97%B4%E9%9A%94%7C%20B%5Bcurl%20%2Fmcp%2Fhealth%5D%0A%20%20%20%20B%20--%3E%20C%7B%E5%93%8D%E5%BA%94%E6%AD%A3%E5%B8%B8%3F%7D%0A%20%20%20%20C%20--%3E%7C%E6%98%AF%7C%20D%5B%E6%A0%87%E8%AE%B0%E5%81%A5%E5%BA%B7%5D%0A%20%20%20%20C%20--%3E%7C%E5%90%A6%7C%20E%5B%E7%B4%AF%E8%AE%A1%E5%A4%B1%E8%B4%A5%E6%AC%A1%E6%95%B0%5D%0A%20%20%20%20E%20--%3E%20F%7B%E5%A4%B1%E8%B4%A53%E6%AC%A1%3F%7D%0A%20%20%20%20F%20--%3E%7C%E6%98%AF%7C%20G%5B%E5%AE%B9%E5%99%A8%E9%87%8D%E5%90%AF%5D%0A%20%20%20%20F%20--%3E%7C%E5%90%A6%7C%20B%0A%20%20%20%20D%20--%3E%20H%5B%E7%BB%A7%E7%BB%AD%E7%9B%91%E6%8E%A7%5D%0A%20%20%20%20H%20--%3E%20B%0A%0A%20%20%20%20style%20G%20fill%3A%23f44336%2Ccolor%3A%23fff%0A"})]),fallback:i(()=>[...s[11]||(s[11]=[p(" Loading... ",-1)])]),_:1})),s[25]||(s[25]=n(`<p><strong>健康检查机制详解：</strong></p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">healthcheck</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  test</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;CMD&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;curl&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;-f&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;http://localhost:8000/mcp/health&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  interval</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">30s</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> # 检查间隔</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  timeout</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">10s</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> # 超时时间</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  retries</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> # 失败重试次数</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  start_period</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">40s</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> # 启动宽限期</span></span></code></pre></div><p><strong>健康检查端点实现：</strong></p><div class="language-python vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">@app.api_route</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;/mcp/health&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">methods</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;GET&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;POST&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">])</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">async</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> health_check</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">():</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        &quot;status&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;healthy&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        &quot;service&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">SERVER_NAME</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        &quot;version&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">SERVER_VERSION</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        &quot;protocol&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;sse&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span></code></pre></div><p><strong>工作流程：</strong></p><ol><li><strong>启动阶段</strong>：容器启动后 40 秒内不进行健康检查（start_period），等待服务初始化完成</li><li><strong>正常运行</strong>：每 30 秒检查一次，10 秒内必须响应</li><li><strong>异常检测</strong>：连续失败 3 次，标记为 unhealthy</li><li><strong>自动恢复</strong>：Docker 自动重启 unhealthy 的容器</li></ol><p><strong>健康检查的价值：</strong></p><ul><li>进程僵死 → 自动重启</li><li>依赖服务不可用 → 快速发现问题</li><li>配合监控系统 → 及时告警</li><li>支持负载均衡 → 摘除不健康实例</li></ul><h3 id="_6-3-性能指标" tabindex="-1">6.3 性能指标 <a class="header-anchor" href="#_6-3-性能指标" aria-label="Permalink to &quot;6.3 性能指标&quot;">​</a></h3><p>系统在实际运行中的性能表现：</p><p>待补充</p><p><strong>性能优化空间：</strong></p><p>如果未来需要进一步优化，可以考虑：</p><ul><li>使用 Redis 实现分布式 Session 缓存（支持多实例部署）</li><li>接口文档预加载和本地缓存（减少 YApi 请求）</li><li>启用 HTTP/2（提升传输效率）</li></ul><h2 id="七、故障排查" tabindex="-1">七、故障排查 <a class="header-anchor" href="#七、故障排查" aria-label="Permalink to &quot;七、故障排查&quot;">​</a></h2><p>遇到问题时的系统化排查流程：</p>`,16)),(a(),l(e,null,{default:i(()=>[h(t,{id:"mermaid-1220",class:"mermaid",graph:"graph%20TB%0A%20%20%20%20A%5B%E8%BF%9E%E6%8E%A5%E5%A4%B1%E8%B4%A5%5D%20--%3E%20B%7B%E6%A3%80%E6%9F%A5%E7%82%B9%7D%0A%20%20%20%20B%20--%3E%20C%5BNginx%20%E7%8A%B6%E6%80%81%5D%0A%20%20%20%20B%20--%3E%20D%5B%E5%AE%B9%E5%99%A8%E8%BF%90%E8%A1%8C%E7%8A%B6%E6%80%81%5D%0A%20%20%20%20B%20--%3E%20E%5B%E7%BD%91%E7%BB%9C%E8%BF%9E%E9%80%9A%E6%80%A7%5D%0A%20%20%20%20B%20--%3E%20F%5B%E8%AE%A4%E8%AF%81%E4%BF%A1%E6%81%AF%5D%0A%0A%20%20%20%20C%20--%3E%20G%5Bsystemctl%20status%20nginx%5D%0A%20%20%20%20D%20--%3E%20H%5Bdocker-compose%20ps%5D%0A%20%20%20%20E%20--%3E%20I%5Bcurl%20%E5%81%A5%E5%BA%B7%E6%A3%80%E6%9F%A5%5D%0A%20%20%20%20F%20--%3E%20J%5B%E9%AA%8C%E8%AF%81%20mcp.json%5D%0A%0A%20%20%20%20G%20--%3E%20K%5B%E6%9F%A5%E7%9C%8B%20Nginx%20%E6%97%A5%E5%BF%97%5D%0A%20%20%20%20H%20--%3E%20L%5B%E6%9F%A5%E7%9C%8B%E5%AE%B9%E5%99%A8%E6%97%A5%E5%BF%97%5D%0A%20%20%20%20I%20--%3E%20M%5B%E6%B5%8B%E8%AF%95%E7%AB%AF%E5%8F%A3%E9%80%9A%E7%95%85%5D%0A%20%20%20%20J%20--%3E%20N%5B%E9%AA%8C%E8%AF%81%E7%94%A8%E6%88%B7%E5%90%8D%E5%AF%86%E7%A0%81%5D%0A"})]),fallback:i(()=>[...s[12]||(s[12]=[p(" Loading... ",-1)])]),_:1})),s[26]||(s[26]=n(`<p><strong>常见问题及解决方案：</strong></p><h3 id="_7-1-连接失败-无法建立-sse-连接" tabindex="-1">7.1. 连接失败：无法建立 SSE 连接 <a class="header-anchor" href="#_7-1-连接失败-无法建立-sse-连接" aria-label="Permalink to &quot;7.1. 连接失败：无法建立 SSE 连接&quot;">​</a></h3><p><strong>排查步骤：</strong></p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 1. 检查容器是否运行</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">docker-compose</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ps</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 应该看到 api-docs-mcp-server 状态为 Up</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 2. 检查容器日志</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">docker-compose</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> logs</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -f</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> api-docs-mcp</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 查看是否有启动错误</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 3. 测试容器内部</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">curl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> http://localhost:9527/mcp/health</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 应该返回 {&quot;status&quot;: &quot;healthy&quot;, ...}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 4. 测试 Nginx 代理</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">curl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> https://your-domain.com/mcp/health</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 如果失败，检查 Nginx 配置</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 5. 检查 Nginx 状态和日志</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> systemctl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> status</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> nginx</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> tail</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -f</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /var/log/nginx/error.log</span></span></code></pre></div><h3 id="_7-2-认证失败-401-或-403-错误" tabindex="-1">7.2. 认证失败：401 或 403 错误 <a class="header-anchor" href="#_7-2-认证失败-401-或-403-错误" aria-label="Permalink to &quot;7.2. 认证失败：401 或 403 错误&quot;">​</a></h3><p><strong>可能原因：</strong></p><ul><li>mcp.json 中用户名或密码错误</li><li>YApi 账号被锁定或禁用</li><li>YApi 登录接口地址错误</li></ul><p><strong>解决方案：</strong></p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 1. 验证用户名密码</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">curl</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -X</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> POST</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> https://yapi.your-domain.com/api/user/login</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  -H</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;Content-Type: application/json&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  -d</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;{&quot;email&quot;: &quot;user@example.com&quot;, &quot;password&quot;: &quot;your-password&quot;}&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 2. 检查容器日志中的认证日志</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">docker-compose</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> logs</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -f</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> grep</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;登录&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 3. 更新 mcp.json 配置</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">vim</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ~/.cursor/mcp.json</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 修改 username 和 password</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 4. 重启 Cursor IDE 使配置生效</span></span></code></pre></div><h3 id="_7-3-查询失败-无法获取接口文档" tabindex="-1">7.3. 查询失败：无法获取接口文档 <a class="header-anchor" href="#_7-3-查询失败-无法获取接口文档" aria-label="Permalink to &quot;7.3. 查询失败：无法获取接口文档&quot;">​</a></h3><p><strong>可能原因：</strong></p><ul><li>URL 格式错误</li><li>接口 ID 不存在</li><li>没有访问权限</li></ul><p><strong>解决方案：</strong></p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 1. 验证 URL 格式</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 正确：https://yapi.com/project/interface/api/12345</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 或：https://yapi.com/api/interface/get?id=12345</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 2. 查看详细错误日志</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">docker-compose</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> logs</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -f</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> grep</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;ERROR&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 3. 测试接口是否存在</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 在浏览器中访问 YApi 页面，确认接口可访问</span></span></code></pre></div><h3 id="_7-4-性能问题-响应缓慢" tabindex="-1">7.4. 性能问题：响应缓慢 <a class="header-anchor" href="#_7-4-性能问题-响应缓慢" aria-label="Permalink to &quot;7.4. 性能问题：响应缓慢&quot;">​</a></h3><p><strong>排查步骤：</strong></p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 1. 检查 Session 缓存命中率</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">docker-compose</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> logs</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -f</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> grep</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;缓存&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> grep</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;使用&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 2. 检查网络延迟</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ping</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> yapi.your-domain.com</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 3. 检查容器资源使用</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">docker</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> stats</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> api-docs-mcp-server</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 4. 查看并发请求数</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">docker-compose</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> logs</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -f</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> grep</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;活跃会话数&quot;</span></span></code></pre></div><h2 id="八、总结" tabindex="-1">八、总结 <a class="header-anchor" href="#八、总结" aria-label="Permalink to &quot;八、总结&quot;">​</a></h2><h3 id="_8-1-项目价值与收益" tabindex="-1">8.1 项目价值与收益 <a class="header-anchor" href="#_8-1-项目价值与收益" aria-label="Permalink to &quot;8.1 项目价值与收益&quot;">​</a></h3><p>本项目解决了 AI 辅助开发中文档获取的核心问题，通过 MCP 协议实现内网文档的智能访问，带来显著的效率提升。</p><p><strong>量化收益对比：</strong></p><table><thead><tr><th>维度</th><th>传统方式</th><th>使用 MCP 服务</th><th>提升幅度</th></tr></thead><tbody><tr><td>AI 访问文档</td><td>无法访问内网</td><td>自动登录访问</td><td>0→1</td></tr><tr><td>查文档时间</td><td>2-3 分钟/次</td><td>0 秒（AI 自动查询）</td><td>∞</td></tr><tr><td>写代码时间</td><td>5-8 分钟/接口</td><td>10 秒/接口</td><td>30-48x</td></tr><tr><td>新人上手时间</td><td>1-2 周熟悉接口文档</td><td>立即可用</td><td>减少 90%</td></tr><tr><td>文档获取时效性</td><td>手动查询，可能查到旧文档</td><td>实时获取最新版本</td><td>按需获取</td></tr></tbody></table><p><strong>核心价值：</strong></p><ol><li><strong>突破内网限制</strong> - 作为 AI 与内网 YApi 的桥梁，解决 AI 无法访问内网的根本问题</li><li><strong>自动认证管理</strong> - Session 缓存机制，30 天免登录，性能提升 600 倍</li><li><strong>按需实时查询</strong> - 无需手动同步，确保 AI 始终基于最新文档生成代码</li><li><strong>高可用保障</strong> - 自动重试、健康检查、容器化部署，服务稳定可靠</li></ol><h2 id="结语" tabindex="-1">结语 <a class="header-anchor" href="#结语" aria-label="Permalink to &quot;结语&quot;">​</a></h2><p>本项目不仅是一个技术实现，更是对&quot;如何让 AI 更好地辅助开发&quot;的一次探索。通过 MCP 协议，我们为 AI 提供了获取外部知识的能力，让它能够按需查询最新、准确的信息生成代码。</p><p>期待与大家一起探索 AI 辅助开发的无限可能！</p>`,27))])}const u=k(d,[["render",o]]);export{C as __pageData,u as default};
