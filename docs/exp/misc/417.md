# Kubernetes å®è·µç¬”è®°

## 1. å‡†å¤‡å·¥ä½œ

åœ¨å¼€å§‹ Kubernetes å­¦ä¹ ä¹‹å‰ï¼Œéœ€è¦é…ç½®å¥½æœ¬åœ°ç¯å¢ƒã€‚ä»¥ä¸‹æ˜¯å¿…éœ€çš„å·¥å…·å’Œå®‰è£…æ­¥éª¤ã€‚

### 1.1 å®‰è£… Docker

Docker æ˜¯å®¹å™¨åŒ–æŠ€æœ¯çš„åŸºç¡€ï¼Œç”¨äºæ„å»ºå’Œè¿è¡Œå®¹å™¨é•œåƒã€‚

#### æ¨èå®‰è£…æ–¹æ³•

ä½¿ç”¨ Docker Desktop æ˜¯æœ€ç®€å•çš„å®‰è£…æ–¹æ¡ˆï¼š

1. è®¿é—® [Docker Desktop å®˜ç½‘](https://www.docker.com/products/docker-desktop/)
2. ä¸‹è½½å¯¹åº”æ“ä½œç³»ç»Ÿçš„å®‰è£…åŒ…
3. æŒ‰ç…§å®‰è£…å‘å¯¼å®Œæˆå®‰è£…

**éªŒè¯å®‰è£…ï¼š**

```bash
docker run hello-world
```

#### æ›¿ä»£å®‰è£…æ–¹æ³•

ç”±äº Docker Desktop å¯¹å¤§å‹ä¼ä¸šæ”¶è´¹ï¼ˆ2021 å¹´èµ·ï¼‰ï¼Œå¯ä»¥é€‰æ‹©åªå®‰è£… Docker CLIã€‚

### 1.2 å®‰è£… Minikube

Minikube ç”¨äºåœ¨æœ¬åœ°æ­å»º Kubernetes é›†ç¾¤ï¼Œæ˜¯å­¦ä¹  K8s çš„ç†æƒ³é€‰æ‹©ã€‚

**MacOS å®‰è£…ï¼š**

```bash
brew install minikube
```

**å¯åŠ¨ Minikubeï¼š**

å¦‚æœä½¿ç”¨ Docker Desktopï¼š

```bash
minikube start --vm-driver docker --container-runtime=docker
```

å¦‚æœåªæœ‰ Docker CLIï¼š

```bash
brew install hyperkit
minikube start --vm-driver hyperkit --container-runtime=docker

# é…ç½® Docker CLI è¿æ¥åˆ° minikube
eval $(minikube docker-env)

# æ·»åŠ ä¸»æœºåæ˜ å°„
echo "`minikube ip` docker.local" | sudo tee -a /etc/hosts > /dev/null

# æµ‹è¯•
docker run hello-world
```

**éªŒè¯å®‰è£…ï¼š**

```bash
minikube status
```

#### Minikube å¸¸ç”¨å‘½ä»¤

```mermaid
graph TD
    A[Minikube å‘½ä»¤] --> B[minikube start]
    A --> C[minikube stop]
    A --> D[minikube delete]
    A --> E[minikube status]
    A --> F[minikube ip]
    A --> G[minikube pause]

    B --> B1[å¯åŠ¨é›†ç¾¤<br/>ä¸åˆ é™¤æ•°æ®]
    C --> C1[åœæ­¢é›†ç¾¤<br/>ä¿ç•™æ•°æ®]
    D --> D1[åˆ é™¤æ‰€æœ‰æ•°æ®<br/>å®Œå…¨æ¸…ç†]
    E --> E1[æŸ¥çœ‹é›†ç¾¤çŠ¶æ€]
    F --> F1[è·å–é›†ç¾¤IPåœ°å€]
    G --> G1[æš‚åœèµ„æºå’Œé›†ç¾¤]
```

| å‘½ä»¤              | åŠŸèƒ½                 |
| ----------------- | -------------------- |
| `minikube start`  | å¯åŠ¨ Kubernetes é›†ç¾¤ |
| `minikube stop`   | åœæ­¢é›†ç¾¤ï¼ˆä¿ç•™æ•°æ®ï¼‰ |
| `minikube delete` | åˆ é™¤æ‰€æœ‰é›†ç¾¤æ•°æ®     |
| `minikube status` | æŸ¥çœ‹é›†ç¾¤çŠ¶æ€         |
| `minikube ip`     | è·å–é›†ç¾¤ IP åœ°å€     |
| `minikube pause`  | æš‚åœé›†ç¾¤èµ„æº         |

### 1.3 å®‰è£… kubectl

kubectl æ˜¯ Kubernetes çš„å‘½ä»¤è¡Œå·¥å…·ï¼Œç”¨äºä¸é›†ç¾¤äº¤äº’ã€‚

**MacOS å®‰è£…ï¼š**

```bash
brew install kubectl
```

> **æ³¨æ„ï¼š** å¦‚æœä¸å®‰è£… kubectlï¼Œå¯ä»¥ä½¿ç”¨ `minikube kubectl` å‘½ä»¤æ›¿ä»£æ‰€æœ‰ `kubectl` æ“ä½œã€‚

### 1.4 æ³¨å†Œ Docker Hub è´¦å·

ç”±äº Minikube é»˜è®¤ä» DockerHub æ‹‰å–é•œåƒï¼Œéœ€è¦ï¼š

1. åœ¨ [Docker Hub](https://hub.docker.com/) æ³¨å†Œè´¦å·
2. ä½¿ç”¨å‘½ä»¤è¡Œç™»å½•ï¼š

```bash
docker login
```

### ç¯å¢ƒæ¶æ„å›¾

```mermaid
graph TB
    subgraph "æœ¬åœ°å¼€å‘ç¯å¢ƒ"
        A[Docker Desktop/CLI] --> B[å®¹å™¨è¿è¡Œæ—¶]
        C[Minikube] --> D[æœ¬åœ° K8s é›†ç¾¤]
        E[kubectl] --> D
        F[Docker Hub] --> B
    end

    subgraph "å¼€å‘æµç¨‹"
        G[ç¼–å†™ä»£ç ] --> H[æ„å»ºé•œåƒ]
        H --> I[æ¨é€åˆ° Docker Hub]
        I --> J[éƒ¨ç½²åˆ° K8s é›†ç¾¤]
    end

    B --> D
    D --> J
```

### å‡†å¤‡å·¥ä½œæ£€æŸ¥æ¸…å•

- [ ] Docker å®‰è£…å¹¶èƒ½è¿è¡Œ `hello-world`
- [ ] Minikube å®‰è£…å¹¶æˆåŠŸå¯åŠ¨
- [ ] kubectl å®‰è£…ï¼ˆæˆ–ä½¿ç”¨ `minikube kubectl`ï¼‰
- [ ] Docker Hub è´¦å·æ³¨å†Œå¹¶ç™»å½•
- [ ] `minikube status` æ˜¾ç¤ºé›†ç¾¤è¿è¡Œæ­£å¸¸

å®Œæˆä»¥ä¸Šå‡†å¤‡å·¥ä½œåï¼Œå°±å¯ä»¥å¼€å§‹ Kubernetes çš„å®è·µå­¦ä¹ äº†ã€‚

## 2. Containerï¼ˆå®¹å™¨åŒ–ï¼‰

å®¹å™¨åŒ–æ˜¯ Kubernetes çš„åŸºç¡€ã€‚æˆ‘ä»¬ä»ä¸€ä¸ªç®€å•çš„ Go åº”ç”¨å¼€å§‹ï¼Œå­¦ä¹ å¦‚ä½•å°†ä»£ç æ‰“åŒ…æˆå®¹å™¨é•œåƒã€‚

### 2.1 ç¤ºä¾‹åº”ç”¨

åˆ›å»ºä¸€ä¸ªç®€å•çš„ Go Web æœåŠ¡ï¼š

#### main.go

```go
package main

import (
 "io"
 "net/http"
)

func hello(w http.ResponseWriter, r *http.Request) {
 io.WriteString(w, "[v1] Hello, Kubernetes!")
}

func main() {
 http.HandleFunc("/", hello)
 http.ListenAndServe(":3000", nil)
}
```

è¿™ä¸ªåº”ç”¨ï¼š

- å¯åŠ¨ HTTP æœåŠ¡å™¨ï¼Œç›‘å¬ 3000 ç«¯å£
- è®¿é—®æ ¹è·¯å¾„ `/` æ—¶è¿”å› `[v1] Hello, Kubernetes!`

### 2.2 å®¹å™¨åŒ–çš„ä¼˜åŠ¿

```mermaid
graph LR
    subgraph "ä¼ ç»Ÿéƒ¨ç½²"
        A1[å®‰è£… Go ç¯å¢ƒ] --> A2[é…ç½®ç¯å¢ƒå˜é‡]
        A2 --> A3[å¤„ç†ä¾èµ–]
        A3 --> A4[ç¼–è¯‘è¿è¡Œ]
        A4 --> A5[å¯èƒ½çš„ç¯å¢ƒé—®é¢˜]
    end

    subgraph "å®¹å™¨åŒ–éƒ¨ç½²"
        B1[ç¼–å†™ Dockerfile] --> B2[æ„å»ºé•œåƒ]
        B2 --> B3[è¿è¡Œå®¹å™¨]
        B3 --> B4[ä¸€è‡´çš„è¿è¡Œç¯å¢ƒ]
    end
```

**å®¹å™¨åŒ–çš„å¥½å¤„ï¼š**

- **ç¯å¢ƒä¸€è‡´æ€§**ï¼šæ¶ˆé™¤"åœ¨æˆ‘æœºå™¨ä¸Šèƒ½è¿è¡Œ"çš„é—®é¢˜
- **å¿«é€Ÿéƒ¨ç½²**ï¼šæ— éœ€å®‰è£…è¿è¡Œæ—¶ç¯å¢ƒ
- **èµ„æºéš”ç¦»**ï¼šæ²™ç›’æŠ€æœ¯ä¿è¯å®‰å…¨æ€§
- **æ˜“äºåˆ†å‘**ï¼šé•œåƒå¯ä»¥è½»æ¾å…±äº«

### 2.3 ç¼–å†™ Dockerfile

#### Dockerfile

```dockerfile
# å¤šé˜¶æ®µæ„å»ºï¼šå…ˆç¼–è¯‘ï¼Œå†æ‰“åŒ…
FROM golang:1.16-buster AS builder
RUN mkdir /src
ADD . /src
WORKDIR /src

RUN go env -w GO111MODULE=auto
RUN go build -o main .

# ä½¿ç”¨ç²¾ç®€çš„åŸºç¡€é•œåƒ
FROM gcr.io/distroless/base-debian10

WORKDIR /
COPY --from=builder /src/main /main
EXPOSE 3000
ENTRYPOINT ["/main"]
```

**å¤šé˜¶æ®µæ„å»ºçš„ä¼˜åŠ¿ï¼š**

- å°† 300MB çš„é•œåƒå‹ç¼©åˆ° 20MB
- ä¸Šä¼ åˆ° Docker Hub åä»… 10MB
- æé«˜ç½‘ç»œä¼ è¾“æ•ˆç‡

### 2.4 æ„å»ºå’Œè¿è¡Œ

**æ„å»ºé•œåƒï¼š**

```bash
# æ›¿æ¢ guangzhengli ä¸ºä½ çš„ Docker Hub ç”¨æˆ·å
docker build . -t guangzhengli/hellok8s:v1
```

**æŸ¥çœ‹é•œåƒï¼š**

```bash
docker images
# guangzhengli/hellok8s    v1    f956e8cf7d18    8 days ago    25.4MB
```

**è¿è¡Œå®¹å™¨ï¼š**

```bash
docker run -p 3000:3000 --name hellok8s -d guangzhengli/hellok8s:v1
```

**æµ‹è¯•åº”ç”¨ï¼š**

```bash
# æœ¬åœ°æµ‹è¯•
curl http://127.0.0.1:3000

# å¦‚æœä½¿ç”¨ minikubeï¼Œéœ€è¦ä½¿ç”¨ minikube IP
minikube ip  # ä¾‹å¦‚è¿”å› 192.168.59.100
curl http://192.168.59.100:3000
```

**æ¨é€åˆ° Docker Hubï¼š**

```bash
docker push guangzhengli/hellok8s:v1
```

### 2.5 å®¹å™¨æŠ€æœ¯åŸç†

```mermaid
graph TB
    subgraph "å®¹å™¨æŠ€æœ¯åŸºç¡€"
        A[Linux Namespace] --> D[å®¹å™¨éš”ç¦»]
        B[Cgroups] --> D
        C[chroot] --> D
    end

    subgraph "å®¹å™¨ vs è™šæ‹Ÿæœº"
        E[å®¿ä¸»æœºæ“ä½œç³»ç»Ÿ] --> F[å®¹å™¨è¿è¡Œæ—¶]
        F --> G[å®¹å™¨1]
        F --> H[å®¹å™¨2]
        F --> I[å®¹å™¨3]

        J[å®¿ä¸»æœºæ“ä½œç³»ç»Ÿ] --> K[è™šæ‹ŸåŒ–å±‚]
        K --> L[è™šæ‹Ÿæœº1<br/>å®Œæ•´OS]
        K --> M[è™šæ‹Ÿæœº2<br/>å®Œæ•´OS]
    end
```

**å®¹å™¨æ˜¯ä»€ä¹ˆï¼Ÿ**

- åŸºäº Linux Namespaceã€Cgroupsã€chroot ç­‰æŠ€æœ¯
- æä¾›è¿›ç¨‹çº§åˆ«çš„éš”ç¦»
- å…±äº«å®¿ä¸»æœºå†…æ ¸ï¼Œæ¯”è™šæ‹Ÿæœºæ›´è½»é‡

### 2.6 å®¹å™¨åŒ–æµç¨‹å›¾

```mermaid
flowchart TD
    A[ç¼–å†™åº”ç”¨ä»£ç ] --> B[åˆ›å»º Dockerfile]
    B --> C[æ„å»ºé•œåƒ<br/>docker build]
    C --> D[æµ‹è¯•é•œåƒ<br/>docker run]
    D --> E{æµ‹è¯•é€šè¿‡?}
    E -->|å¦| B
    E -->|æ˜¯| F[æ¨é€é•œåƒ<br/>docker push]
    F --> G[é•œåƒä»“åº“<br/>Docker Hub]
    G --> H[å…¶ä»–ç¯å¢ƒæ‹‰å–<br/>docker pull]
    H --> I[éƒ¨ç½²è¿è¡Œ<br/>docker run]
```

### 2.7 å®è·µç»ƒä¹ 

å°è¯•å®¹å™¨åŒ–å…¶ä»–æœåŠ¡ï¼š

1. **Nginx æœåŠ¡**

   ```bash
   docker pull nginx
   docker run -p 8080:80 nginx
   ```

2. **MySQL æ•°æ®åº“**

   ```bash
   docker pull mysql:8.0
   docker run -e MYSQL_ROOT_PASSWORD=password -p 3306:3306 mysql:8.0
   ```

3. **Redis ç¼“å­˜**

   ```bash
   docker pull redis
   docker run -p 6379:6379 redis
   ```

### å°ç»“ï¼šå®¹å™¨åŒ–

é€šè¿‡è¿™ä¸ªç« èŠ‚ï¼Œæˆ‘ä»¬å­¦ä¼šäº†ï¼š

- âœ… ç¼–å†™ç®€å•çš„ Go Web åº”ç”¨
- âœ… åˆ›å»º Dockerfile è¿›è¡Œå®¹å™¨åŒ–
- âœ… ä½¿ç”¨å¤šé˜¶æ®µæ„å»ºä¼˜åŒ–é•œåƒå¤§å°
- âœ… æ„å»ºã€è¿è¡Œå’Œæ¨é€ Docker é•œåƒ
- âœ… ç†è§£å®¹å™¨æŠ€æœ¯çš„åŸºæœ¬åŸç†

å®¹å™¨åŒ–è§£å†³äº†åº”ç”¨éƒ¨ç½²çš„ç¯å¢ƒä¸€è‡´æ€§é—®é¢˜ï¼Œä¸ºåç»­çš„ Kubernetes å­¦ä¹ å¥ å®šäº†åŸºç¡€ã€‚

## 3. Podï¼ˆæœ€å°éƒ¨ç½²å•å…ƒï¼‰

Pod æ˜¯ Kubernetes ä¸­å¯ä»¥åˆ›å»ºå’Œç®¡ç†çš„æœ€å°å¯éƒ¨ç½²è®¡ç®—å•å…ƒã€‚ç†è§£ Pod æ˜¯æŒæ¡ Kubernetes çš„å…³é”®ç¬¬ä¸€æ­¥ã€‚

### 3.1 ä»€ä¹ˆæ˜¯ Pod

```mermaid
graph TB
    subgraph "Pod æ¦‚å¿µ"
        A[Pod] --> B[Container 1]
        A --> C[Container 2]
        A --> D[å…±äº«ç½‘ç»œ]
        A --> E[å…±äº«å­˜å‚¨]
    end

    subgraph "Pod vs Container"
        F[å•ä¸ª Container] --> F1[ç‹¬ç«‹è¿›ç¨‹]
        G[Pod] --> G1[ç®¡ç†ä¸€ç»„è¿›ç¨‹]
        G1 --> G2[å…±äº« localhost]
        G1 --> G3[å…±äº«æ–‡ä»¶ç³»ç»Ÿ]
    end
```

**Pod çš„ç‰¹ç‚¹ï¼š**

- åŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ªå®¹å™¨
- å®¹å™¨å…±äº«ç½‘ç»œå’Œå­˜å‚¨
- Pod å†…å®¹å™¨å¯ä»¥é€šè¿‡ `localhost` é€šä¿¡
- Pod æ˜¯åŸå­æ€§çš„éƒ¨ç½²å•ä½

### 3.2 åˆ›å»ºç¬¬ä¸€ä¸ª Pod

è®©æˆ‘ä»¬ä»ä¸€ä¸ªç®€å•çš„ Nginx Pod å¼€å§‹ï¼š

#### nginx.yaml

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: nginx-pod
spec:
  containers:
    - name: nginx-container
      image: nginx
```

**YAML æ–‡ä»¶è§£æï¼š**

- `apiVersion: v1` - API ç‰ˆæœ¬
- `kind: Pod` - èµ„æºç±»å‹
- `metadata.name` - Pod åç§°ï¼ˆé›†ç¾¤å†…å”¯ä¸€ï¼‰
- `spec.containers` - å®¹å™¨å®šä¹‰åˆ—è¡¨

### 3.3 Pod æ“ä½œå®è·µ

**åˆ›å»º Podï¼š**

```bash
kubectl apply -f nginx.yaml
# pod/nginx-pod created
```

**æŸ¥çœ‹ Pod çŠ¶æ€ï¼š**

```bash
kubectl get pods
# NAME        READY   STATUS    RESTARTS   AGE
# nginx-pod   1/1     Running   0          6s
```

**ç«¯å£è½¬å‘è®¿é—®ï¼š**

```bash
kubectl port-forward nginx-pod 4000:80
# Forwarding from 127.0.0.1:4000 -> 80
# Forwarding from [::1]:4000 -> 80
```

**æµ‹è¯•è®¿é—®ï¼š**

```bash
curl http://127.0.0.1:4000
# è¿”å› Nginx é»˜è®¤é¡µé¢
```

### 3.4 è¿›å…¥ Pod å®¹å™¨

**æ‰§è¡Œå‘½ä»¤ï¼š**

```bash
kubectl exec -it nginx-pod -- /bin/bash
```

**ä¿®æ”¹ Nginx é¦–é¡µï¼š**

```bash
echo "hello kubernetes by nginx!" > /usr/share/nginx/html/index.html
exit
```

**å†æ¬¡æµ‹è¯•ï¼š**

```bash
kubectl port-forward nginx-pod 4000:80
curl http://127.0.0.1:4000
# hello kubernetes by nginx!
```

### 3.5 Pod ç”Ÿå‘½å‘¨æœŸ

```mermaid
stateDiagram-v2
    [*] --> Pending: åˆ›å»º Pod
    Pending --> Running: å®¹å™¨å¯åŠ¨æˆåŠŸ
    Running --> Succeeded: å®¹å™¨æ­£å¸¸é€€å‡º
    Running --> Failed: å®¹å™¨å¼‚å¸¸é€€å‡º
    Running --> Unknown: èŠ‚ç‚¹é€šä¿¡å¤±è´¥
    Succeeded --> [*]
    Failed --> [*]
    Unknown --> Running: æ¢å¤é€šä¿¡
    Unknown --> Failed: ç¡®è®¤å¤±è´¥
```

**Pod çŠ¶æ€è¯´æ˜ï¼š**

- **Pending**: Pod å·²åˆ›å»ºï¼Œä½†å®¹å™¨æœªå¯åŠ¨
- **Running**: Pod å·²ç»‘å®šåˆ°èŠ‚ç‚¹ï¼Œæ‰€æœ‰å®¹å™¨å·²åˆ›å»º
- **Succeeded**: æ‰€æœ‰å®¹å™¨æˆåŠŸç»ˆæ­¢
- **Failed**: è‡³å°‘ä¸€ä¸ªå®¹å™¨å¤±è´¥ç»ˆæ­¢
- **Unknown**: æ— æ³•è·å– Pod çŠ¶æ€

### 3.6 Pod ä¸ Container çš„å…³ç³»

```mermaid
graph TB
    subgraph "Kubernetes é›†ç¾¤"
        subgraph "Node 1"
            subgraph "Pod A"
                A1[Nginx Container]
                A2[Sidecar Container]
                A3[å…±äº«ç½‘ç»œ localhost]
                A4[å…±äº«å­˜å‚¨å·]
            end

            subgraph "Pod B"
                B1[App Container]
            end
        end

        subgraph "Node 2"
            subgraph "Pod C"
                C1[Database Container]
            end
        end
    end
```

**ä½¿ç”¨åœºæ™¯ï¼š**

1. **å•å®¹å™¨ Pod**ï¼ˆæœ€å¸¸è§ï¼‰
   - ä¸€ä¸ª Pod åŒ…å«ä¸€ä¸ªåº”ç”¨å®¹å™¨
2. **å¤šå®¹å™¨ Pod**ï¼ˆç‰¹æ®Šåœºæ™¯ï¼‰
   - æ—¥å¿—æ”¶é›†ï¼šä¸»åº”ç”¨ + æ—¥å¿—æ”¶é›†å™¨
   - ä»£ç†æœåŠ¡ï¼šä¸»åº”ç”¨ + ç½‘ç»œä»£ç†
   - æ•°æ®åŒæ­¥ï¼šä¸»åº”ç”¨ + æ•°æ®åŒæ­¥å™¨

### 3.7 åˆ›å»º HelloK8s Pod

åŸºäºä¹‹å‰æ„å»ºçš„é•œåƒåˆ›å»º Podï¼š

#### hellok8s.yaml

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: hellok8s
spec:
  containers:
    - name: hellok8s-container
      image: guangzhengli/hellok8s:v1
```

**éƒ¨ç½²å’Œæµ‹è¯•ï¼š**

```bash
kubectl apply -f hellok8s.yaml
kubectl get pods
kubectl port-forward hellok8s 3000:3000

# æ–°ç»ˆç«¯æµ‹è¯•
curl http://localhost:3000
# [v1] Hello, Kubernetes!
```

### 3.8 Pod å¸¸ç”¨å‘½ä»¤

```mermaid
graph TD
    A[Pod ç®¡ç†å‘½ä»¤] --> B[kubectl apply -f pod.yaml]
    A --> C[kubectl get pods]
    A --> D[kubectl describe pod]
    A --> E[kubectl logs pod-name]
    A --> F[kubectl exec -it pod-name]
    A --> G[kubectl delete pod]

    B --> B1[åˆ›å»º/æ›´æ–° Pod]
    C --> C1[æŸ¥çœ‹ Pod åˆ—è¡¨]
    D --> D1[æŸ¥çœ‹ Pod è¯¦æƒ…]
    E --> E1[æŸ¥çœ‹ Pod æ—¥å¿—]
    F --> F1[è¿›å…¥ Pod æ‰§è¡Œå‘½ä»¤]
    G --> G1[åˆ é™¤ Pod]
```

**å¸¸ç”¨å‘½ä»¤æ±‡æ€»ï¼š**

| å‘½ä»¤                                  | åŠŸèƒ½                |
| ------------------------------------- | ------------------- |
| `kubectl apply -f pod.yaml`           | åˆ›å»ºæˆ–æ›´æ–° Pod      |
| `kubectl get pods`                    | æŸ¥çœ‹ Pod åˆ—è¡¨       |
| `kubectl get pods -o wide`            | æŸ¥çœ‹ Pod è¯¦ç»†ä¿¡æ¯   |
| `kubectl describe pod <name>`         | æŸ¥çœ‹ Pod è¯¦æƒ…å’Œäº‹ä»¶ |
| `kubectl logs <pod-name>`             | æŸ¥çœ‹ Pod æ—¥å¿—       |
| `kubectl logs -f <pod-name>`          | å®æ—¶æŸ¥çœ‹æ—¥å¿—        |
| `kubectl exec -it <pod> -- /bin/bash` | è¿›å…¥ Pod æ‰§è¡Œå‘½ä»¤   |
| `kubectl port-forward <pod> 8080:80`  | ç«¯å£è½¬å‘            |
| `kubectl delete pod <name>`           | åˆ é™¤ Pod            |
| `kubectl delete -f pod.yaml`          | é€šè¿‡æ–‡ä»¶åˆ é™¤ Pod    |

### 3.9 æ•…éšœæ’æŸ¥

**Pod å¯åŠ¨å¤±è´¥æ’æŸ¥ï¼š**

1. **æŸ¥çœ‹ Pod çŠ¶æ€ï¼š**

   ```bash
   kubectl get pods
   # NAME       READY   STATUS    RESTARTS   AGE
   # hellok8s   0/1     ImagePullBackOff   0          22m
   ```

2. **æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯ï¼š**

   ```bash
   kubectl describe pod hellok8s
   ```

3. **å¸¸è§é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆï¼š**

   - `ImagePullBackOff`: é•œåƒæ‹‰å–å¤±è´¥

     ```bash
     # åˆ‡æ¢åˆ° minikube docker ç¯å¢ƒ
     eval $(minikube docker-env)
     # é‡æ–°æ„å»ºé•œåƒ
     docker build . -t guangzhengli/hellok8s:v1
     ```

   - `CrashLoopBackOff`: å®¹å™¨å¯åŠ¨åç«‹å³é€€å‡º
   - `Pending`: èµ„æºä¸è¶³æˆ–è°ƒåº¦å¤±è´¥

### 3.10 Pod ç½‘ç»œæ¨¡å‹

```mermaid
graph TB
    subgraph "Pod ç½‘ç»œ"
        A[Pod IP: 10.244.1.5] --> B[Container 1<br/>localhost:8080]
        A --> C[Container 2<br/>localhost:9090]

        D[Pod IP: 10.244.1.6] --> E[Container 3<br/>localhost:3000]
    end

    subgraph "é›†ç¾¤ç½‘ç»œ"
        F[Service] --> A
        F --> D
        G[Ingress] --> F
    end
```

**ç½‘ç»œç‰¹ç‚¹ï¼š**

- æ¯ä¸ª Pod æœ‰å”¯ä¸€çš„ IP åœ°å€
- Pod å†…å®¹å™¨å…±äº«ç½‘ç»œå‘½åç©ºé—´
- å®¹å™¨é—´é€šè¿‡ localhost é€šä¿¡
- Pod é—´é€šè¿‡ Pod IP ç›´æ¥é€šä¿¡

### å°ç»“ï¼šPod

é€šè¿‡è¿™ä¸ªç« èŠ‚ï¼Œæˆ‘ä»¬å­¦ä¼šäº†ï¼š

- âœ… ç†è§£ Pod çš„æ¦‚å¿µå’Œä½œç”¨
- âœ… åˆ›å»ºå’Œç®¡ç† Pod èµ„æº
- âœ… ä½¿ç”¨ kubectl æ“ä½œ Pod
- âœ… è¿›å…¥ Pod æ‰§è¡Œå‘½ä»¤å’ŒæŸ¥çœ‹æ—¥å¿—
- âœ… ç†è§£ Pod çš„ç”Ÿå‘½å‘¨æœŸå’Œç½‘ç»œæ¨¡å‹
- âœ… æ’æŸ¥ Pod å¸¸è§é—®é¢˜

Pod æ˜¯ Kubernetes çš„åŸºç¡€æ„å»ºå—ï¼Œä¸ºåç»­å­¦ä¹  Deploymentã€Service ç­‰é«˜çº§æ¦‚å¿µå¥ å®šäº†åŸºç¡€ã€‚

## 4. Deploymentï¼ˆè‡ªåŠ¨åŒ–ç®¡ç†ï¼‰

åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œæˆ‘ä»¬å¾ˆå°‘ç›´æ¥ç®¡ç† Podã€‚Deployment æä¾›äº†å£°æ˜å¼çš„ Pod ç®¡ç†èƒ½åŠ›ï¼ŒåŒ…æ‹¬è‡ªåŠ¨æ‰©å®¹ã€æ»šåŠ¨æ›´æ–°ã€æ•…éšœæ¢å¤ç­‰åŠŸèƒ½ã€‚

### 4.1 ä¸ºä»€ä¹ˆéœ€è¦ Deployment

```mermaid
graph TB
    subgraph "æ‰‹åŠ¨ç®¡ç† Pod çš„é—®é¢˜"
        A1[æ‰‹åŠ¨åˆ›å»º 10 ä¸ª Pod] --> A2[ç‰ˆæœ¬å‡çº§éœ€è¦é€ä¸ªæ›¿æ¢]
        A2 --> A3[Pod æ•…éšœéœ€è¦æ‰‹åŠ¨é‡å¯]
        A3 --> A4[æ‰©å®¹ç¼©å®¹éœ€è¦æ‰‹åŠ¨æ“ä½œ]
        A4 --> A5[ç®¡ç†å¤æ‚åº¦é«˜]
    end

    subgraph "Deployment è‡ªåŠ¨åŒ–ç®¡ç†"
        B1[å£°æ˜æœŸæœ›çŠ¶æ€] --> B2[è‡ªåŠ¨åˆ›å»º Pod]
        B2 --> B3[è‡ªåŠ¨æ»šåŠ¨æ›´æ–°]
        B3 --> B4[è‡ªåŠ¨æ•…éšœæ¢å¤]
        B4 --> B5[è‡ªåŠ¨æ‰©ç¼©å®¹]
    end
```

**Deployment è§£å†³çš„é—®é¢˜ï¼š**

- ğŸ”„ **è‡ªåŠ¨æ•…éšœæ¢å¤**ï¼šPod å¼‚å¸¸æ—¶è‡ªåŠ¨é‡å»º
- ğŸ“ˆ **å¼¹æ€§ä¼¸ç¼©**ï¼šæ ¹æ®éœ€æ±‚è‡ªåŠ¨è°ƒæ•´å‰¯æœ¬æ•°
- ğŸš€ **æ»šåŠ¨æ›´æ–°**ï¼šé›¶åœæœºæ—¶é—´çš„ç‰ˆæœ¬å‡çº§
- ğŸ“ **å£°æ˜å¼ç®¡ç†**ï¼šæè¿°æœŸæœ›çŠ¶æ€ï¼Œç³»ç»Ÿè‡ªåŠ¨è¾¾æˆ

### 4.2 åˆ›å»º Deployment

#### deployment.yaml

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: hellok8s-deployment
spec:
  replicas: 1
  selector:
    matchLabels:
      app: hellok8s
  template:
    metadata:
      labels:
        app: hellok8s
    spec:
      containers:
        - image: guangzhengli/hellok8s:v1
          name: hellok8s-container
```

**é…ç½®è§£æï¼š**

- `replicas: 1` - æœŸæœ›çš„ Pod å‰¯æœ¬æ•°
- `selector.matchLabels` - é€‰æ‹©å™¨ï¼ŒåŒ¹é…è¦ç®¡ç†çš„ Pod
- `template` - Pod æ¨¡æ¿ï¼Œå®šä¹‰åˆ›å»ºçš„ Pod è§„æ ¼
- `labels: app: hellok8s` - Pod æ ‡ç­¾ï¼Œä¸é€‰æ‹©å™¨å¯¹åº”

### 4.3 Deployment è‡ªæ„ˆèƒ½åŠ›

**éƒ¨ç½² Deploymentï¼š**

```bash
kubectl apply -f deployment.yaml
kubectl get deployments
# NAME                  READY   UP-TO-DATE   AVAILABLE   AGE
# hellok8s-deployment   1/1     1            1           39s

kubectl get pods
# NAME                                   READY   STATUS    RESTARTS   AGE
# hellok8s-deployment-77bffb88c5-qlxss   1/1     Running   0          119s
```

**æµ‹è¯•è‡ªæ„ˆèƒ½åŠ›ï¼š**

```bash
# æ‰‹åŠ¨åˆ é™¤ Pod
kubectl delete pod hellok8s-deployment-77bffb88c5-qlxss
# pod "hellok8s-deployment-77bffb88c5-qlxss" deleted

# ç«‹å³æŸ¥çœ‹ï¼Œå‘ç°æ–° Pod è‡ªåŠ¨åˆ›å»º
kubectl get pods
# NAME                                   READY   STATUS    RESTARTS   AGE
# hellok8s-deployment-77bffb88c5-xp8f7   1/1     Running   0          18s
```

### 4.4 è‡ªåŠ¨æ‰©å®¹

```mermaid
sequenceDiagram
    participant User
    participant Deployment
    participant ReplicaSet
    participant Pod

    User->>Deployment: ä¿®æ”¹ replicas: 3
    Deployment->>ReplicaSet: æ›´æ–°æœŸæœ›å‰¯æœ¬æ•°
    ReplicaSet->>Pod: åˆ›å»ºæ–° Pod å®ä¾‹
    Pod->>ReplicaSet: æŠ¥å‘ŠçŠ¶æ€
    ReplicaSet->>Deployment: æ›´æ–°çŠ¶æ€
    Deployment->>User: æ‰©å®¹å®Œæˆ
```

**æ‰©å®¹åˆ° 3 ä¸ªå‰¯æœ¬ï¼š**

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: hellok8s-deployment
spec:
  replicas: 3 # ä¿®æ”¹å‰¯æœ¬æ•°
  selector:
    matchLabels:
      app: hellok8s
  template:
    metadata:
      labels:
        app: hellok8s
    spec:
      containers:
        - image: guangzhengli/hellok8s:v1
          name: hellok8s-container
```

**åº”ç”¨æ›´æ”¹ï¼š**

```bash
kubectl apply -f deployment.yaml

# è§‚å¯Ÿæ‰©å®¹è¿‡ç¨‹
kubectl get pods --watch
# NAME                                   READY   STATUS    RESTARTS   AGE
# hellok8s-deployment-77bffb88c5-xp8f7   1/1     Running   0          5m
# hellok8s-deployment-77bffb88c5-abc123  0/1     Pending   0          1s
# hellok8s-deployment-77bffb88c5-def456  0/1     Pending   0          1s
# hellok8s-deployment-77bffb88c5-abc123  1/1     Running   0          10s
# hellok8s-deployment-77bffb88c5-def456  1/1     Running   0          12s
```

### 4.5 ç‰ˆæœ¬å‡çº§

**æ„å»º v2 ç‰ˆæœ¬ï¼š**

#### main.go (v2)

```go
package main

import (
 "io"
 "net/http"
)

func hello(w http.ResponseWriter, r *http.Request) {
 io.WriteString(w, "[v2] Hello, Kubernetes!")
}

func main() {
 http.HandleFunc("/", hello)
 http.ListenAndServe(":3000", nil)
}
```

**æ„å»ºå’Œæ¨é€ï¼š**

```bash
docker build . -t guangzhengli/hellok8s:v2
docker push guangzhengli/hellok8s:v2
```

**æ›´æ–° Deploymentï¼š**

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: hellok8s-deployment
spec:
  replicas: 3
  selector:
    matchLabels:
      app: hellok8s
  template:
    metadata:
      labels:
        app: hellok8s
    spec:
      containers:
        - image: guangzhengli/hellok8s:v2 # æ›´æ–°é•œåƒç‰ˆæœ¬
          name: hellok8s-container
```

**åº”ç”¨æ›´æ–°ï¼š**

```bash
kubectl apply -f deployment.yaml
kubectl get pods
kubectl port-forward hellok8s-deployment-66799848c4-kpc6q 3000:3000

# æµ‹è¯•æ–°ç‰ˆæœ¬
curl http://localhost:3000
# [v2] Hello, Kubernetes!
```

### 4.6 æ»šåŠ¨æ›´æ–°ç­–ç•¥

```mermaid
graph TD
    subgraph "æ»šåŠ¨æ›´æ–°è¿‡ç¨‹"
        A[3ä¸ª v1 Pod] --> B[2ä¸ª v1 + 1ä¸ª v2]
        B --> C[1ä¸ª v1 + 2ä¸ª v2]
        C --> D[3ä¸ª v2 Pod]
    end

    subgraph "æ›´æ–°ç­–ç•¥é…ç½®"
        E[maxSurge: 1] --> F[æœ€å¤šé¢å¤–åˆ›å»º 1 ä¸ª Pod]
        G[maxUnavailable: 1] --> H[æœ€å¤šåœæ­¢ 1 ä¸ª Pod]
    end
```

**é…ç½®æ»šåŠ¨æ›´æ–°ç­–ç•¥ï¼š**

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: hellok8s-deployment
spec:
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1 # æœ€å¤§å³°å€¼ï¼šå¯ä»¥åˆ›å»ºçš„è¶…å‡ºæœŸæœ› Pod æ•°çš„ Pod æ•°é‡
      maxUnavailable: 1 # æœ€å¤§ä¸å¯ç”¨ï¼šæ›´æ–°è¿‡ç¨‹ä¸­ä¸å¯ç”¨çš„ Pod æ•°é‡ä¸Šé™
  replicas: 3
  selector:
    matchLabels:
      app: hellok8s
  template:
    metadata:
      labels:
        app: hellok8s
    spec:
      containers:
        - image: guangzhengli/hellok8s:v2
          name: hellok8s-container
```

**æ›´æ–°ç­–ç•¥ç±»å‹ï¼š**

- **RollingUpdate**ï¼ˆé»˜è®¤ï¼‰ï¼šé€æ­¥æ›¿æ¢æ—§ Pod
- **Recreate**ï¼šå…ˆåˆ é™¤æ‰€æœ‰æ—§ Podï¼Œå†åˆ›å»ºæ–° Pod

### 4.7 ç‰ˆæœ¬å›æ»š

**æŸ¥çœ‹éƒ¨ç½²å†å²ï¼š**

```bash
kubectl rollout history deployment hellok8s-deployment
# REVISION  CHANGE-CAUSE
# 1         <none>
# 2         <none>
```

**å›æ»šåˆ°ä¸Šä¸€ç‰ˆæœ¬ï¼š**

```bash
kubectl rollout undo deployment hellok8s-deployment
# deployment.apps/hellok8s-deployment rolled back

kubectl get pods
kubectl describe pod hellok8s-deployment-77bffb88c5-cvm5c
# Image: guangzhengli/hellok8s:v1  # å·²å›æ»šåˆ° v1
```

**å›æ»šåˆ°æŒ‡å®šç‰ˆæœ¬ï¼š**

```bash
kubectl rollout undo deployment/hellok8s-deployment --to-revision=2
```

### 4.8 å¥åº·æ£€æŸ¥

#### 4.8.1 å­˜æ´»æ¢é’ˆ (Liveness Probe)

å­˜æ´»æ¢é’ˆç”¨äºæ£€æµ‹å®¹å™¨æ˜¯å¦è¿˜åœ¨è¿è¡Œï¼Œå¦‚æœæ£€æµ‹å¤±è´¥ï¼Œkubelet ä¼šé‡å¯å®¹å™¨ã€‚

**å¸¦å¥åº·æ£€æŸ¥çš„åº”ç”¨ (v3)ï¼š**

```go
package main

import (
 "fmt"
 "io"
 "net/http"
 "time"
)

func hello(w http.ResponseWriter, r *http.Request) {
 io.WriteString(w, "[v3] Hello, Kubernetes!")
}

func main() {
 started := time.Now()
 http.HandleFunc("/healthz", func(w http.ResponseWriter, r *http.Request) {
  duration := time.Since(started)
  if duration.Seconds() > 15 {
   w.WriteHeader(500)
   w.Write([]byte(fmt.Sprintf("error: %v", duration.Seconds())))
  } else {
   w.WriteHeader(200)
   w.Write([]byte("ok"))
  }
 })

 http.HandleFunc("/", hello)
 http.ListenAndServe(":3000", nil)
}
```

**é…ç½®å­˜æ´»æ¢é’ˆï¼š**

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: hellok8s-deployment
spec:
  replicas: 3
  selector:
    matchLabels:
      app: hellok8s
  template:
    metadata:
      labels:
        app: hellok8s
    spec:
      containers:
        - image: guangzhengli/hellok8s:liveness
          name: hellok8s-container
          livenessProbe:
            httpGet:
              path: /healthz
              port: 3000
            initialDelaySeconds: 3 # å¯åŠ¨åç­‰å¾…æ—¶é—´
            periodSeconds: 3 # æ£€æŸ¥é—´éš”
```

**è§‚å¯Ÿé‡å¯è¡Œä¸ºï¼š**

```bash
kubectl apply -f deployment.yaml
kubectl get pods
# NAME                                   READY   STATUS    RESTARTS     AGE
# hellok8s-deployment-5995ff9447-d5fbz   1/1     Running   4 (6s ago)   102s

kubectl describe pod hellok8s-deployment-5995ff9447-d5fbz
# Events:
#   Normal   Killing    11m (x3 over 12m)     kubelet            Container hellok8s-container failed liveness probe, will be restarted
```

#### 4.8.2 å°±ç»ªæ¢é’ˆ (Readiness Probe)

å°±ç»ªæ¢é’ˆç”¨äºæ£€æµ‹å®¹å™¨æ˜¯å¦å‡†å¤‡å¥½æ¥å—æµé‡ï¼Œå¦‚æœæ£€æµ‹å¤±è´¥ï¼ŒPod ä¼šä» Service çš„è´Ÿè½½å‡è¡¡ä¸­ç§»é™¤ã€‚

**æ¨¡æ‹Ÿæœ‰é—®é¢˜çš„ç‰ˆæœ¬ï¼š**

```go
package main

import (
 "io"
 "net/http"
)

func hello(w http.ResponseWriter, r *http.Request) {
 io.WriteString(w, "[bad] Hello, Kubernetes!")
}

func main() {
 http.HandleFunc("/healthz", func(w http.ResponseWriter, r *http.Request) {
  w.WriteHeader(500)  // å§‹ç»ˆè¿”å›é”™è¯¯
 })

 http.HandleFunc("/", hello)
 http.ListenAndServe(":3000", nil)
}
```

**é…ç½®å°±ç»ªæ¢é’ˆï¼š**

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: hellok8s-deployment
spec:
  strategy:
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 1
  replicas: 3
  selector:
    matchLabels:
      app: hellok8s
  template:
    metadata:
      labels:
        app: hellok8s
    spec:
      containers:
        - image: guangzhengli/hellok8s:bad
          name: hellok8s-container
          readinessProbe:
            httpGet:
              path: /healthz
              port: 3000
            initialDelaySeconds: 1
            successThreshold: 5 # è¿ç»­æˆåŠŸ 5 æ¬¡æ‰è®¤ä¸ºå°±ç»ª
```

**è§‚å¯Ÿæ»šåŠ¨æ›´æ–°è¢«é˜»æ­¢ï¼š**

```bash
kubectl apply -f deployment.yaml
kubectl get pods
# NAME                                   READY   STATUS    RESTARTS   AGE
# hellok8s-deployment-66799848c4-8xzsz   1/1     Running   0          102s  # æ—§ç‰ˆæœ¬ç»§ç»­è¿è¡Œ
# hellok8s-deployment-66799848c4-m9dl5   1/1     Running   0          102s  # æ—§ç‰ˆæœ¬ç»§ç»­è¿è¡Œ
# hellok8s-deployment-9c57c7f56-rww7k    0/1     Running   0          26s   # æ–°ç‰ˆæœ¬æœªå°±ç»ª
# hellok8s-deployment-9c57c7f56-xt9tw    0/1     Running   0          26s   # æ–°ç‰ˆæœ¬æœªå°±ç»ª
```

### 4.9 Deployment æ¶æ„å›¾

```mermaid
graph TB
    subgraph "Deployment æ§åˆ¶å™¨"
        A[Deployment] --> B[ReplicaSet v1]
        A --> C[ReplicaSet v2]

        B --> D[Pod v1-1]
        B --> E[Pod v1-2]

        C --> F[Pod v2-1]
        C --> G[Pod v2-2]
        C --> H[Pod v2-3]
    end

    subgraph "æ»šåŠ¨æ›´æ–°è¿‡ç¨‹"
        I[ç”¨æˆ·æ›´æ–°é•œåƒ] --> J[åˆ›å»ºæ–° ReplicaSet]
        J --> K[é€æ­¥åˆ›å»ºæ–° Pod]
        K --> L[é€æ­¥åˆ é™¤æ—§ Pod]
        L --> M[æ›´æ–°å®Œæˆ]
    end
```

**ç»„ä»¶å…³ç³»ï¼š**

- **Deployment**ï¼šç®¡ç† ReplicaSet çš„ç”Ÿå‘½å‘¨æœŸ
- **ReplicaSet**ï¼šç¡®ä¿æŒ‡å®šæ•°é‡çš„ Pod å‰¯æœ¬è¿è¡Œ
- **Pod**ï¼šå®é™…è¿è¡Œçš„åº”ç”¨å®ä¾‹

### 4.10 å¸¸ç”¨å‘½ä»¤

| å‘½ä»¤                                                      | åŠŸèƒ½                 |
| --------------------------------------------------------- | -------------------- |
| `kubectl create deployment <name> --image=<image>`        | å¿«é€Ÿåˆ›å»º Deployment  |
| `kubectl get deployments`                                 | æŸ¥çœ‹ Deployment åˆ—è¡¨ |
| `kubectl describe deployment <name>`                      | æŸ¥çœ‹ Deployment è¯¦æƒ… |
| `kubectl scale deployment <name> --replicas=5`            | æ‰©ç¼©å®¹               |
| `kubectl set image deployment/<name> <container>=<image>` | æ›´æ–°é•œåƒ             |
| `kubectl rollout status deployment/<name>`                | æŸ¥çœ‹æ»šåŠ¨æ›´æ–°çŠ¶æ€     |
| `kubectl rollout history deployment/<name>`               | æŸ¥çœ‹æ›´æ–°å†å²         |
| `kubectl rollout undo deployment/<name>`                  | å›æ»šåˆ°ä¸Šä¸€ç‰ˆæœ¬       |
| `kubectl rollout restart deployment/<name>`               | é‡å¯ Deployment      |

### å°ç»“ï¼šDeployment

é€šè¿‡è¿™ä¸ªç« èŠ‚ï¼Œæˆ‘ä»¬å­¦ä¼šäº†ï¼š

- âœ… ç†è§£ Deployment çš„ä½œç”¨å’Œä¼˜åŠ¿
- âœ… åˆ›å»ºå’Œç®¡ç† Deployment èµ„æº
- âœ… å®ç°è‡ªåŠ¨æ‰©ç¼©å®¹å’Œæ•…éšœæ¢å¤
- âœ… é…ç½®æ»šåŠ¨æ›´æ–°ç­–ç•¥
- âœ… ä½¿ç”¨å¥åº·æ£€æŸ¥ä¿è¯æœåŠ¡å¯ç”¨æ€§
- âœ… è¿›è¡Œç‰ˆæœ¬å‡çº§å’Œå›æ»šæ“ä½œ

Deployment æ˜¯ Kubernetes ä¸­æœ€é‡è¦çš„å·¥ä½œè´Ÿè½½èµ„æºï¼Œä¸ºåº”ç”¨æä¾›äº†ç”Ÿäº§çº§çš„éƒ¨ç½²å’Œç®¡ç†èƒ½åŠ›ã€‚

## 5. Serviceï¼ˆæœåŠ¡å‘ç°ä¸è´Ÿè½½å‡è¡¡ï¼‰

Service è§£å†³äº† Pod IP åœ°å€ä¸ç¨³å®šå’Œè´Ÿè½½å‡è¡¡çš„é—®é¢˜ï¼Œä¸ºä¸€ç»„ Pod æä¾›ç¨³å®šçš„ç½‘ç»œè®¿é—®å…¥å£ã€‚

### 5.1 ä¸ºä»€ä¹ˆéœ€è¦ Service

```mermaid
graph TB
    subgraph "æ²¡æœ‰ Service çš„é—®é¢˜"
        A1[Pod IP ä¼šå˜åŒ–] --> A2[æ— æ³•ç¨³å®šè®¿é—®]
        A3[å¤šä¸ª Pod å‰¯æœ¬] --> A4[å¦‚ä½•è´Ÿè½½å‡è¡¡?]
        A5[Pod é‡å¯] --> A6[IP åœ°å€æ”¹å˜]
    end

    subgraph "Service è§£å†³æ–¹æ¡ˆ"
        B1[Service æä¾›ç¨³å®š IP] --> B2[è‡ªåŠ¨è´Ÿè½½å‡è¡¡]
        B2 --> B3[æœåŠ¡å‘ç°]
        B3 --> B4[å¥åº·æ£€æŸ¥]
    end
```

**Service è§£å†³çš„é—®é¢˜ï¼š**

- ğŸ”— **ç¨³å®šè®¿é—®**ï¼šä¸º Pod æä¾›ä¸å˜çš„è®¿é—®åœ°å€
- âš–ï¸ **è´Ÿè½½å‡è¡¡**ï¼šè‡ªåŠ¨åˆ†å‘è¯·æ±‚åˆ°å¤šä¸ª Pod
- ğŸ” **æœåŠ¡å‘ç°**ï¼šé€šè¿‡ DNS åç§°è®¿é—®æœåŠ¡
- ğŸ¥ **å¥åº·æ£€æŸ¥**ï¼šåªå‘å°±ç»ªçš„ Pod è½¬å‘æµé‡

### 5.2 å‡†å¤‡æµ‹è¯•ç¯å¢ƒ

é¦–å…ˆåˆ›å»ºä¸€ä¸ªè¿”å›ä¸»æœºåçš„åº”ç”¨ç‰ˆæœ¬ï¼š

#### main.go (v3)

```go
package main

import (
 "fmt"
 "io"
 "net/http"
 "os"
)

func hello(w http.ResponseWriter, r *http.Request) {
 host, _ := os.Hostname()
 io.WriteString(w, fmt.Sprintf("[v3] Hello, Kubernetes!, From host: %s", host))
}

func main() {
 http.HandleFunc("/", hello)
 http.ListenAndServe(":3000", nil)
}
```

**æ„å»ºå’Œéƒ¨ç½²ï¼š**

```bash
docker build . -t guangzhengli/hellok8s:v3
docker push guangzhengli/hellok8s:v3
```

#### deployment.yaml (v3)

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: hellok8s-deployment
spec:
  replicas: 3
  selector:
    matchLabels:
      app: hellok8s
  template:
    metadata:
      labels:
        app: hellok8s
    spec:
      containers:
        - image: guangzhengli/hellok8s:v3
          name: hellok8s-container
```

### 5.3 ClusterIP Service

ClusterIP æ˜¯é»˜è®¤çš„ Service ç±»å‹ï¼Œåªèƒ½åœ¨é›†ç¾¤å†…éƒ¨è®¿é—®ã€‚

#### service-hellok8s-clusterip.yaml

```yaml
apiVersion: v1
kind: Service
metadata:
  name: service-hellok8s-clusterip
spec:
  type: ClusterIP
  selector:
    app: hellok8s # é€‰æ‹©æ ‡ç­¾ä¸º app: hellok8s çš„ Pod
  ports:
    - port: 3000 # Service ç«¯å£
      targetPort: 3000 # Pod ç«¯å£
```

**éƒ¨ç½²å’Œæµ‹è¯•ï¼š**

```bash
kubectl apply -f deployment.yaml
kubectl apply -f service-hellok8s-clusterip.yaml

# æŸ¥çœ‹ Service å’Œ Endpoints
kubectl get service
# NAME                         TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)    AGE
# service-hellok8s-clusterip   ClusterIP   10.104.96.153   <none>        3000/TCP   10s

kubectl get endpoints
# NAME                         ENDPOINTS                                          AGE
# service-hellok8s-clusterip   172.17.0.10:3000,172.17.0.2:3000,172.17.0.3:3000   10s

kubectl get pod -o wide
# NAME                                   READY   STATUS    RESTARTS   AGE    IP           NODE
# hellok8s-deployment-5d5545b69c-24lw5   1/1     Running   0          112s   172.17.0.7   minikube
# hellok8s-deployment-5d5545b69c-9g94t   1/1     Running   0          112s   172.17.0.3   minikube
# hellok8s-deployment-5d5545b69c-9gm8r   1/1     Running   0          112s   172.17.0.2   minikube
```

### 5.4 Service å·¥ä½œåŸç†

```mermaid
graph TB
    subgraph "Service è´Ÿè½½å‡è¡¡"
        A[Client Request] --> B[Service<br/>10.104.96.153:3000]
        B --> C[Pod 1<br/>172.17.0.2:3000]
        B --> D[Pod 2<br/>172.17.0.3:3000]
        B --> E[Pod 3<br/>172.17.0.7:3000]
    end

    subgraph "Endpoints è‡ªåŠ¨æ›´æ–°"
        F[Pod åˆ›å»º/åˆ é™¤] --> G[Endpoints æ§åˆ¶å™¨]
        G --> H[æ›´æ–° Endpoints åˆ—è¡¨]
        H --> I[Service é‡æ–°è·¯ç”±]
    end
```

**åœ¨é›†ç¾¤å†…æµ‹è¯• Serviceï¼š**

åˆ›å»ºä¸€ä¸ªæµ‹è¯• Podï¼š

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: nginx
  labels:
    app: nginx
spec:
  containers:
    - name: nginx-container
      image: nginx
```

```bash
kubectl apply -f nginx.yaml
kubectl exec -it nginx -- /bin/bash

# åœ¨ nginx å®¹å™¨å†…æµ‹è¯•
curl 10.104.96.153:3000
# [v3] Hello, Kubernetes!, From host: hellok8s-deployment-5d5545b69c-9gm8r

curl 10.104.96.153:3000
# [v3] Hello, Kubernetes!, From host: hellok8s-deployment-5d5545b69c-9g94t
```

å¯ä»¥çœ‹åˆ°æ¯æ¬¡è¯·æ±‚è¿”å›ä¸åŒçš„ä¸»æœºåï¼Œè¯´æ˜ Service åœ¨è‡ªåŠ¨è´Ÿè½½å‡è¡¡ã€‚

### 5.5 NodePort Service

NodePort é€šè¿‡æ¯ä¸ªèŠ‚ç‚¹çš„ IP å’Œé™æ€ç«¯å£æš´éœ²æœåŠ¡ï¼Œå¯ä»¥ä»é›†ç¾¤å¤–éƒ¨è®¿é—®ã€‚

```mermaid
graph TB
    subgraph "NodePort æ¶æ„"
        A[å¤–éƒ¨å®¢æˆ·ç«¯] --> B[Node IP:30000]
        B --> C[NodePort Service]
        C --> D[ClusterIP Service<br/>è‡ªåŠ¨åˆ›å»º]
        D --> E[Pod 1]
        D --> F[Pod 2]
        D --> G[Pod 3]
    end
```

#### service-hellok8s-nodeport.yaml

```yaml
apiVersion: v1
kind: Service
metadata:
  name: service-hellok8s-nodeport
spec:
  type: NodePort
  selector:
    app: hellok8s
  ports:
    - port: 3000
      nodePort: 30000 # èŠ‚ç‚¹ç«¯å£ (30000-32767)
```

**éƒ¨ç½²å’Œæµ‹è¯•ï¼š**

```bash
kubectl apply -f service-hellok8s-nodeport.yaml

kubectl get service
# NAME                         TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)          AGE
# service-hellok8s-nodeport    NodePort    10.109.188.161   <none>        3000:30000/TCP   28s

# è·å– minikube IP
minikube ip
# 192.168.59.100

# ä»é›†ç¾¤å¤–éƒ¨è®¿é—®
curl http://192.168.59.100:30000
# [v3] Hello, Kubernetes!, From host: hellok8s-deployment-5d5545b69c-9g94t
```

**Docker Desktop ç”¨æˆ·æ³¨æ„ï¼š**
å¦‚æœæ— æ³•é€šè¿‡ Node IP è®¿é—®ï¼Œä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ï¼š

```bash
minikube service service-hellok8s-nodeport --url
# http://127.0.0.1:50896

curl http://127.0.0.1:50896
# [v3] Hello, Kubernetes!, From host: hellok8s-deployment-559cfdd58c-zp2pc
```

### 5.6 LoadBalancer Service

LoadBalancer ä½¿ç”¨äº‘æä¾›å•†çš„è´Ÿè½½å‡è¡¡å™¨å‘å¤–éƒ¨æš´éœ²æœåŠ¡ã€‚

```mermaid
graph TB
    subgraph "LoadBalancer æ¶æ„"
        A[äº’è”ç½‘æµé‡] --> B[äº‘è´Ÿè½½å‡è¡¡å™¨<br/>ELB/ALB/GCP LB]
        B --> C[NodePort Service<br/>è‡ªåŠ¨åˆ›å»º]
        C --> D[ClusterIP Service<br/>è‡ªåŠ¨åˆ›å»º]
        D --> E[Pod 1]
        D --> F[Pod 2]
        D --> G[Pod 3]
    end
```

#### service-hellok8s-loadbalancer.yaml

```yaml
apiVersion: v1
kind: Service
metadata:
  name: service-hellok8s-loadbalancer
spec:
  type: LoadBalancer
  selector:
    app: hellok8s
  ports:
    - port: 3000
      targetPort: 3000
```

**åœ¨äº‘ç¯å¢ƒä¸­çš„æ•ˆæœï¼š**

```bash
kubectl get service
# NAME                            TYPE           CLUSTER-IP     EXTERNAL-IP      PORT(S)          AGE
# service-hellok8s-loadbalancer   LoadBalancer   10.100.200.1   52.123.45.67     3000:31234/TCP   2m
```

> **æ³¨æ„ï¼š** åœ¨ minikube ä¸­éœ€è¦ä½¿ç”¨ `minikube tunnel` æ¥æ¨¡æ‹Ÿ LoadBalancerï¼Œä½†ä¸çœŸå®äº‘ç¯å¢ƒæœ‰å·®å¼‚ã€‚

### 5.7 Service ç±»å‹å¯¹æ¯”

```mermaid
graph TD
    subgraph "Service ç±»å‹å¯¹æ¯”"
        A[ClusterIP] --> A1[é›†ç¾¤å†…éƒ¨è®¿é—®<br/>é»˜è®¤ç±»å‹]
        B[NodePort] --> B1[é€šè¿‡èŠ‚ç‚¹ç«¯å£è®¿é—®<br/>30000-32767]
        C[LoadBalancer] --> C1[äº‘è´Ÿè½½å‡è¡¡å™¨<br/>è‡ªåŠ¨åˆ†é…å¤–éƒ¨IP]
        D[ExternalName] --> D1[DNS CNAME æ˜ å°„<br/>æ— ä»£ç†]
    end

    subgraph "ä½¿ç”¨åœºæ™¯"
        E[å†…éƒ¨æœåŠ¡é€šä¿¡] --> A
        F[å¼€å‘æµ‹è¯•ç¯å¢ƒ] --> B
        G[ç”Ÿäº§ç¯å¢ƒ] --> C
        H[å¤–éƒ¨æœåŠ¡æ˜ å°„] --> D
    end
```

| Service ç±»å‹     | è®¿é—®æ–¹å¼       | ä½¿ç”¨åœºæ™¯     | å¤–éƒ¨è®¿é—® |
| ---------------- | -------------- | ------------ | -------- |
| **ClusterIP**    | é›†ç¾¤å†…éƒ¨ IP    | å†…éƒ¨æœåŠ¡é€šä¿¡ | âŒ       |
| **NodePort**     | èŠ‚ç‚¹ IP + ç«¯å£ | å¼€å‘æµ‹è¯•     | âœ…       |
| **LoadBalancer** | äº‘è´Ÿè½½å‡è¡¡å™¨   | ç”Ÿäº§ç¯å¢ƒ     | âœ…       |
| **ExternalName** | DNS CNAME      | å¤–éƒ¨æœåŠ¡æ˜ å°„ | N/A      |

### 5.8 Service å‘ç°

Kubernetes æä¾›äº†å¤šç§æœåŠ¡å‘ç°æœºåˆ¶ï¼š

#### 5.8.1 ç¯å¢ƒå˜é‡

```bash
kubectl exec -it nginx -- env | grep HELLOK8S
# SERVICE_HELLOK8S_CLUSTERIP_SERVICE_HOST=10.104.96.153
# SERVICE_HELLOK8S_CLUSTERIP_SERVICE_PORT=3000
```

#### 5.8.2 DNS è§£æ

```bash
kubectl exec -it nginx -- nslookup service-hellok8s-clusterip
# Name: service-hellok8s-clusterip.default.svc.cluster.local
# Address: 10.104.96.153

# ç›´æ¥é€šè¿‡æœåŠ¡åè®¿é—®
kubectl exec -it nginx -- curl service-hellok8s-clusterip:3000
# [v3] Hello, Kubernetes!, From host: hellok8s-deployment-5d5545b69c-24lw5
```

**DNS å‘½åè§„åˆ™ï¼š**

```text
<service-name>.<namespace>.svc.cluster.local
```

### 5.9 Service ç½‘ç»œæ¨¡å‹

```mermaid
graph TB
    subgraph "Kubernetes ç½‘ç»œå±‚æ¬¡"
        A[Ingress Controller] --> B[Service Layer]
        B --> C[Pod Network]

        subgraph "Service Layer"
            D[ClusterIP Service] --> E[Endpoints]
            F[NodePort Service] --> D
            G[LoadBalancer Service] --> F
        end

        subgraph "Pod Network"
            H[Pod 1: 10.244.1.5]
            I[Pod 2: 10.244.1.6]
            J[Pod 3: 10.244.1.7]
        end

        E --> H
        E --> I
        E --> J
    end
```

### 5.10 Service é«˜çº§ç‰¹æ€§

#### 5.10.1 ä¼šè¯äº²å’Œæ€§

```yaml
apiVersion: v1
kind: Service
metadata:
  name: service-hellok8s-session
spec:
  type: ClusterIP
  sessionAffinity: ClientIP # åŸºäºå®¢æˆ·ç«¯ IP çš„ä¼šè¯ä¿æŒ
  selector:
    app: hellok8s
  ports:
    - port: 3000
      targetPort: 3000
```

#### 5.10.2 å¤šç«¯å£æœåŠ¡

```yaml
apiVersion: v1
kind: Service
metadata:
  name: service-hellok8s-multiport
spec:
  type: ClusterIP
  selector:
    app: hellok8s
  ports:
    - name: http
      port: 80
      targetPort: 3000
    - name: https
      port: 443
      targetPort: 3443
```

#### 5.10.3 æ— å¤´æœåŠ¡ (Headless Service)

```yaml
apiVersion: v1
kind: Service
metadata:
  name: service-hellok8s-headless
spec:
  clusterIP: None # æ— å¤´æœåŠ¡
  selector:
    app: hellok8s
  ports:
    - port: 3000
      targetPort: 3000
```

æ— å¤´æœåŠ¡ç›´æ¥è¿”å› Pod IP åœ°å€ï¼Œå¸¸ç”¨äºæœ‰çŠ¶æ€åº”ç”¨ã€‚

### 5.11 Service æ•…éšœæ’æŸ¥

**å¸¸è§é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆï¼š**

1. **Service æ— æ³•è®¿é—®**

   ```bash
   # æ£€æŸ¥ Service é…ç½®
   kubectl describe service <service-name>

   # æ£€æŸ¥ Endpoints
   kubectl get endpoints <service-name>

   # æ£€æŸ¥ Pod æ ‡ç­¾
   kubectl get pods --show-labels
   ```

2. **è´Ÿè½½å‡è¡¡ä¸å·¥ä½œ**

   ```bash
   # æ£€æŸ¥ Pod å°±ç»ªçŠ¶æ€
   kubectl get pods

   # æ£€æŸ¥å°±ç»ªæ¢é’ˆé…ç½®
   kubectl describe pod <pod-name>
   ```

3. **DNS è§£æå¤±è´¥**

   ```bash
   # æµ‹è¯• DNS è§£æ
   kubectl exec -it <pod> -- nslookup <service-name>

   # æ£€æŸ¥ CoreDNS
   kubectl get pods -n kube-system | grep coredns
   ```

### 5.12 Service æœ€ä½³å®è·µ

```mermaid
graph TD
    A[Service æœ€ä½³å®è·µ] --> B[åˆç†é€‰æ‹© Service ç±»å‹]
    A --> C[é…ç½®å¥åº·æ£€æŸ¥]
    A --> D[ä½¿ç”¨æœ‰æ„ä¹‰çš„æ ‡ç­¾]
    A --> E[ç›‘æ§ Service æ€§èƒ½]

    B --> B1[å†…éƒ¨é€šä¿¡ç”¨ ClusterIP]
    B --> B2[ç”Ÿäº§ç¯å¢ƒç”¨ LoadBalancer]

    C --> C1[é…ç½® readinessProbe]
    C --> C2[è®¾ç½®åˆç†çš„è¶…æ—¶æ—¶é—´]

    D --> D1[ä½¿ç”¨è¯­ä¹‰åŒ–æ ‡ç­¾]
    D --> D2[é¿å…æ ‡ç­¾å†²çª]

    E --> E1[ç›‘æ§å»¶è¿Ÿå’Œé”™è¯¯ç‡]
    E --> E2[è®¾ç½®å‘Šè­¦è§„åˆ™]
```

### å°ç»“ï¼šService

é€šè¿‡è¿™ä¸ªç« èŠ‚ï¼Œæˆ‘ä»¬å­¦ä¼šäº†ï¼š

- âœ… ç†è§£ Service çš„ä½œç”¨å’Œé‡è¦æ€§
- âœ… æŒæ¡ä¸åŒç±»å‹ Service çš„ä½¿ç”¨åœºæ™¯
- âœ… é…ç½® ClusterIPã€NodePortã€LoadBalancer
- âœ… ç†è§£æœåŠ¡å‘ç°å’Œè´Ÿè½½å‡è¡¡æœºåˆ¶
- âœ… ä½¿ç”¨ DNS è¿›è¡ŒæœåŠ¡é—´é€šä¿¡
- âœ… æ’æŸ¥ Service å¸¸è§é—®é¢˜

Service æ˜¯ Kubernetes ç½‘ç»œçš„æ ¸å¿ƒç»„ä»¶ï¼Œä¸ºå¾®æœåŠ¡æ¶æ„æä¾›äº†ç¨³å®šå¯é çš„æœåŠ¡é—´é€šä¿¡åŸºç¡€ã€‚

## 6. Ingressï¼ˆæµé‡ç½‘å…³ï¼‰

Ingress æ˜¯ Kubernetes çš„ API ç½‘å…³ï¼Œæä¾› HTTP å’Œ HTTPS è·¯ç”±åŠŸèƒ½ï¼Œæ˜¯é›†ç¾¤å¤–éƒ¨è®¿é—®å†…éƒ¨æœåŠ¡çš„ç»Ÿä¸€å…¥å£ã€‚

### 6.1 ä»€ä¹ˆæ˜¯ Ingress

```mermaid
graph TB
    subgraph "ä¼ ç»Ÿæ–¹å¼çš„é—®é¢˜"
        A1[å¤šä¸ª NodePort Service] --> A2[ç«¯å£ç®¡ç†å¤æ‚]
        A3[LoadBalancer Service] --> A4[æˆæœ¬é«˜æ˜‚]
        A5[ç¼ºä¹è·¯ç”±è§„åˆ™] --> A6[æ— æ³•åŸºäºåŸŸå/è·¯å¾„åˆ†å‘]
    end

    subgraph "Ingress è§£å†³æ–¹æ¡ˆ"
        B1[ç»Ÿä¸€å…¥å£] --> B2[åŸºäºåŸŸåè·¯ç”±]
        B2 --> B3[åŸºäºè·¯å¾„è·¯ç”±]
        B3 --> B4[SSL/TLS ç»ˆç»“]
        B4 --> B5[è´Ÿè½½å‡è¡¡]
    end
```

**Ingress çš„ä¼˜åŠ¿ï¼š**

- ğŸŒ **ç»Ÿä¸€å…¥å£**ï¼šä¸€ä¸ª IP åœ°å€å¤„ç†æ‰€æœ‰å¤–éƒ¨æµé‡
- ğŸ”€ **æ™ºèƒ½è·¯ç”±**ï¼šåŸºäºåŸŸåã€è·¯å¾„è¿›è¡Œæµé‡åˆ†å‘
- ğŸ”’ **SSL ç»ˆç»“**ï¼šé›†ä¸­ç®¡ç† HTTPS è¯ä¹¦
- ğŸ’° **æˆæœ¬ä¼˜åŒ–**ï¼šå‡å°‘ LoadBalancer æ•°é‡

### 6.2 å¯ç”¨ Ingress Controller

åœ¨ minikube ä¸­å¯ç”¨ nginx-ingressï¼š

```bash
minikube addons enable ingress
# âœ…  ingress is now enabled

# éªŒè¯ Ingress Controller è¿è¡ŒçŠ¶æ€
kubectl get pods -n ingress-nginx
# NAME                                        READY   STATUS      RESTARTS   AGE
# ingress-nginx-admission-create-xxx          0/1     Completed   0          2m
# ingress-nginx-admission-patch-xxx           0/1     Completed   1          2m
# ingress-nginx-controller-xxx                1/1     Running     0          2m
```

### 6.3 å‡†å¤‡æµ‹è¯•æœåŠ¡

é¦–å…ˆæ¸…ç†ä¹‹å‰çš„èµ„æºï¼Œç„¶ååˆ›å»ºæµ‹è¯•æœåŠ¡ï¼š

```bash
kubectl delete deployment,service --all
```

**åˆ›å»º HelloK8s æœåŠ¡ï¼š**

#### hellok8s.yaml (Service)

```yaml
apiVersion: v1
kind: Service
metadata:
  name: service-hellok8s-clusterip
spec:
  type: ClusterIP
  selector:
    app: hellok8s
  ports:
    - port: 3000
      targetPort: 3000

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: hellok8s-deployment
spec:
  replicas: 3
  selector:
    matchLabels:
      app: hellok8s
  template:
    metadata:
      labels:
        app: hellok8s
    spec:
      containers:
        - image: guangzhengli/hellok8s:v3
          name: hellok8s-container
```

**åˆ›å»º Nginx æœåŠ¡ï¼š**

#### nginx.yaml (Service)

```yaml
apiVersion: v1
kind: Service
metadata:
  name: service-nginx-clusterip
spec:
  type: ClusterIP
  selector:
    app: nginx
  ports:
    - port: 4000
      targetPort: 80

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx-deployment
spec:
  replicas: 2
  selector:
    matchLabels:
      app: nginx
  template:
    metadata:
      labels:
        app: nginx
    spec:
      containers:
        - image: nginx
          name: nginx-container
```

**éƒ¨ç½²æœåŠ¡ï¼š**

```bash
kubectl apply -f hellok8s.yaml
kubectl apply -f nginx.yaml

kubectl get pods
# NAME                                   READY   STATUS    RESTARTS   AGE
# hellok8s-deployment-5d5545b69c-4wvmf   1/1     Running   0          55s
# hellok8s-deployment-5d5545b69c-qcszp   1/1     Running   0          55s
# hellok8s-deployment-5d5545b69c-sn7mn   1/1     Running   0          55s
# nginx-deployment-d47fd7f66-d9r7x       1/1     Running   0          34s
# nginx-deployment-d47fd7f66-hp5nf       1/1     Running   0          34s
```

### 6.4 åˆ›å»º Ingress è§„åˆ™

#### ingress.yaml

```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: hello-ingress
  annotations:
    # å…³é—­ HTTPS é‡å®šå‘ï¼Œä½¿ç”¨ HTTP
    nginx.ingress.kubernetes.io/ssl-redirect: 'false'
spec:
  rules:
    - http:
        paths:
          - path: /hello
            pathType: Prefix
            backend:
              service:
                name: service-hellok8s-clusterip
                port:
                  number: 3000
          - path: /
            pathType: Prefix
            backend:
              service:
                name: service-nginx-clusterip
                port:
                  number: 4000
```

**é…ç½®è§£æï¼š**

- `path: /hello` - åŒ¹é… `/hello` å‰ç¼€çš„è¯·æ±‚
- `pathType: Prefix` - å‰ç¼€åŒ¹é…æ¨¡å¼
- `backend.service` - åç«¯æœåŠ¡é…ç½®
- `annotations` - Ingress Controller ç‰¹å®šé…ç½®

### 6.5 Ingress è·¯ç”±è§„åˆ™

```mermaid
graph TB
    subgraph "Ingress è·¯ç”±æµç¨‹"
        A[å®¢æˆ·ç«¯è¯·æ±‚] --> B{Ingress Controller}
        B -->|/hello/*| C[HelloK8s Service]
        B -->|/*| D[Nginx Service]

        C --> E[HelloK8s Pod 1]
        C --> F[HelloK8s Pod 2]
        C --> G[HelloK8s Pod 3]

        D --> H[Nginx Pod 1]
        D --> I[Nginx Pod 2]
    end
```

**éƒ¨ç½²å’Œæµ‹è¯•ï¼š**

```bash
kubectl apply -f ingress.yaml

kubectl get ingress
# NAME            CLASS   HOSTS   ADDRESS   PORTS   AGE
# hello-ingress   nginx   *                 80      16s

# è·å– minikube IP
minikube ip
# 192.168.59.100

# æµ‹è¯•è·¯ç”±è§„åˆ™
curl http://192.168.59.100/hello
# [v3] Hello, Kubernetes!, From host: hellok8s-deployment-5d5545b69c-sn7mn

curl http://192.168.59.100/
# <!DOCTYPE html>
# <html>
# <head>
# <title>Welcome to nginx!</title>
```

### 6.6 åŸºäºåŸŸåçš„è·¯ç”±

#### ingress-host.yaml

```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: hello-ingress-host
  annotations:
    nginx.ingress.kubernetes.io/ssl-redirect: 'false'
spec:
  rules:
    - host: hello.k8s.local
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: service-hellok8s-clusterip
                port:
                  number: 3000
    - host: nginx.k8s.local
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: service-nginx-clusterip
                port:
                  number: 4000
```

**é…ç½®æœ¬åœ° DNSï¼š**

```bash
# æ·»åŠ åŸŸåæ˜ å°„åˆ° /etc/hosts
echo "$(minikube ip) hello.k8s.local nginx.k8s.local" | sudo tee -a /etc/hosts

# æµ‹è¯•åŸºäºåŸŸåçš„è·¯ç”±
curl http://hello.k8s.local/
# [v3] Hello, Kubernetes!, From host: hellok8s-deployment-5d5545b69c-4wvmf

curl http://nginx.k8s.local/
# <!DOCTYPE html>
# <html>
# <head>
# <title>Welcome to nginx!</title>
```

### 6.7 HTTPS å’Œ TLS é…ç½®

**åˆ›å»ºè‡ªç­¾åè¯ä¹¦ï¼š**

```bash
# ç”Ÿæˆç§é’¥
openssl genrsa -out tls.key 2048

# ç”Ÿæˆè¯ä¹¦
openssl req -new -x509 -key tls.key -out tls.cert -days 365 -subj /CN=hello.k8s.local

# åˆ›å»º TLS Secret
kubectl create secret tls hello-tls --cert=tls.cert --key=tls.key
```

#### ingress-tls.yaml

```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: hello-ingress-tls
spec:
  tls:
    - hosts:
        - hello.k8s.local
      secretName: hello-tls
  rules:
    - host: hello.k8s.local
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: service-hellok8s-clusterip
                port:
                  number: 3000
```

**æµ‹è¯• HTTPSï¼š**

```bash
kubectl apply -f ingress-tls.yaml

# æµ‹è¯• HTTPS è®¿é—®ï¼ˆå¿½ç•¥è¯ä¹¦éªŒè¯ï¼‰
curl -k https://hello.k8s.local/
# [v3] Hello, Kubernetes!, From host: hellok8s-deployment-5d5545b69c-qcszp
```

### 6.8 Ingress é«˜çº§åŠŸèƒ½

#### 6.8.1 é‡å†™å’Œé‡å®šå‘

```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: hello-ingress-rewrite
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /$2
    nginx.ingress.kubernetes.io/ssl-redirect: 'false'
spec:
  rules:
    - http:
        paths:
          - path: /api(/|$)(.*)
            pathType: Prefix
            backend:
              service:
                name: service-hellok8s-clusterip
                port:
                  number: 3000
```

#### 6.8.2 é™æµå’Œè®¿é—®æ§åˆ¶

```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: hello-ingress-rate-limit
  annotations:
    nginx.ingress.kubernetes.io/rate-limit: '10'
    nginx.ingress.kubernetes.io/rate-limit-window: '1m'
    nginx.ingress.kubernetes.io/whitelist-source-range: '10.0.0.0/8,172.16.0.0/12'
spec:
  rules:
    - http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: service-hellok8s-clusterip
                port:
                  number: 3000
```

#### 6.8.3 è·¨åŸŸé…ç½® (CORS)

```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: hello-ingress-cors
  annotations:
    nginx.ingress.kubernetes.io/enable-cors: 'true'
    nginx.ingress.kubernetes.io/cors-allow-origin: '*'
    nginx.ingress.kubernetes.io/cors-allow-methods: 'GET, POST, PUT, DELETE, OPTIONS'
spec:
  rules:
    - http:
        paths:
          - path: /api
            pathType: Prefix
            backend:
              service:
                name: service-hellok8s-clusterip
                port:
                  number: 3000
```

### 6.9 Ingress Controller å¯¹æ¯”

```mermaid
graph TD
    subgraph "ä¸»æµ Ingress Controller"
        A[Nginx Ingress] --> A1[æœ€æµè¡Œ<br/>åŠŸèƒ½ä¸°å¯Œ]
        B[Traefik] --> B1[è‡ªåŠ¨æœåŠ¡å‘ç°<br/>ç°ä»£åŒ–ç•Œé¢]
        C[HAProxy Ingress] --> C1[é«˜æ€§èƒ½<br/>ä¼ä¸šçº§ç‰¹æ€§]
        D[Istio Gateway] --> D1[æœåŠ¡ç½‘æ ¼<br/>é«˜çº§æµé‡ç®¡ç†]
        E[Kong Ingress] --> E1[API ç½‘å…³<br/>æ’ä»¶ç”Ÿæ€]
    end

    subgraph "é€‰æ‹©æ ‡å‡†"
        F[æ€§èƒ½è¦æ±‚] --> G[åŠŸèƒ½éœ€æ±‚]
        G --> H[ç”Ÿæ€å…¼å®¹æ€§]
        H --> I[è¿ç»´å¤æ‚åº¦]
    end
```

| Ingress Controller  | ä¼˜åŠ¿               | é€‚ç”¨åœºæ™¯           |
| ------------------- | ------------------ | ------------------ |
| **Nginx Ingress**   | æˆç†Ÿç¨³å®šã€åŠŸèƒ½ä¸°å¯Œ | é€šç”¨åœºæ™¯ã€ç”Ÿäº§ç¯å¢ƒ |
| **Traefik**         | é…ç½®ç®€å•ã€è‡ªåŠ¨å‘ç° | å¾®æœåŠ¡ã€å®¹å™¨åŒ–ç¯å¢ƒ |
| **HAProxy Ingress** | é«˜æ€§èƒ½ã€è´Ÿè½½å‡è¡¡   | é«˜å¹¶å‘ã€ä¼ä¸šç¯å¢ƒ   |
| **Istio Gateway**   | æœåŠ¡ç½‘æ ¼ã€å®‰å…¨æ€§   | å¤æ‚å¾®æœåŠ¡æ¶æ„     |
| **Kong Ingress**    | API ç®¡ç†ã€æ’ä»¶     | API ç½‘å…³åœºæ™¯       |

### 6.10 Docker Desktop ç”¨æˆ·è§£å†³æ–¹æ¡ˆ

å¦‚æœä½¿ç”¨ Docker Desktop æ— æ³•é€šè¿‡ minikube IP è®¿é—®ï¼š

```bash
# æŸ¥çœ‹æœåŠ¡åˆ—è¡¨
minikube service list

# é€šè¿‡ minikube ä»£ç†è®¿é—® Ingress
minikube service ingress-nginx-controller -n ingress-nginx --url
# http://127.0.0.1:61691      # HTTP
# http://127.0.0.1:61692      # HTTPS

# æµ‹è¯•è®¿é—®
curl http://127.0.0.1:61691/hello
# [v3] Hello, Kubernetes!, From host: hellok8s-deployment-5d5545b69c-sn7mn

curl http://127.0.0.1:61691/
# <!DOCTYPE html>
# <html>
# <head>
# <title>Welcome to nginx!</title>
```

### 6.11 Ingress æ¶æ„å›¾

```mermaid
graph TB
    subgraph "Ingress å®Œæ•´æ¶æ„"
        A[Internet] --> B[Load Balancer]
        B --> C[Ingress Controller<br/>nginx-ingress]

        C --> D{Ingress Rules}
        D -->|hello.k8s.local/api| E[HelloK8s Service]
        D -->|nginx.k8s.local/*| F[Nginx Service]
        D -->|app.k8s.local/admin| G[Admin Service]

        E --> H[HelloK8s Pods]
        F --> I[Nginx Pods]
        G --> J[Admin Pods]
    end

    subgraph "é…ç½®ç»„ä»¶"
        K[Ingress Resource] --> L[è·¯ç”±è§„åˆ™]
        M[TLS Secret] --> N[HTTPS è¯ä¹¦]
        O[ConfigMap] --> P[Controller é…ç½®]
    end
```

### 6.12 Ingress æœ€ä½³å®è·µ

```mermaid
graph TD
    A[Ingress æœ€ä½³å®è·µ] --> B[å®‰å…¨é…ç½®]
    A --> C[æ€§èƒ½ä¼˜åŒ–]
    A --> D[ç›‘æ§å‘Šè­¦]
    A --> E[è¯ä¹¦ç®¡ç†]

    B --> B1[å¯ç”¨ TLS]
    B --> B2[é…ç½®è®¿é—®æ§åˆ¶]
    B --> B3[é™æµä¿æŠ¤]

    C --> C1[å¯ç”¨ Gzip å‹ç¼©]
    C --> C2[é…ç½®ç¼“å­˜ç­–ç•¥]
    C --> C3[è¿æ¥æ± ä¼˜åŒ–]

    D --> D1[ç›‘æ§å“åº”æ—¶é—´]
    D --> D2[é”™è¯¯ç‡å‘Šè­¦]
    D --> D3[æµé‡ç›‘æ§]

    E --> E1[ä½¿ç”¨ cert-manager]
    E --> E2[è‡ªåŠ¨ç»­æœŸ]
    E --> E3[è¯ä¹¦è½®æ¢]
```

**æ¨èé…ç½®ï¼š**

1. **å®‰å…¨é…ç½®**

   ```yaml
   annotations:
     nginx.ingress.kubernetes.io/ssl-redirect: 'true'
     nginx.ingress.kubernetes.io/force-ssl-redirect: 'true'
     nginx.ingress.kubernetes.io/hsts: 'true'
   ```

2. **æ€§èƒ½ä¼˜åŒ–**

   ```yaml
   annotations:
     nginx.ingress.kubernetes.io/enable-gzip: 'true'
     nginx.ingress.kubernetes.io/proxy-body-size: '50m'
     nginx.ingress.kubernetes.io/proxy-connect-timeout: '600'
   ```

3. **ç›‘æ§é…ç½®**

   ```yaml
   annotations:
     nginx.ingress.kubernetes.io/enable-access-log: 'true'
     nginx.ingress.kubernetes.io/configuration-snippet: |
       more_set_headers "X-Request-ID: $req_id";
   ```

### å°ç»“ï¼šIngress

é€šè¿‡è¿™ä¸ªç« èŠ‚ï¼Œæˆ‘ä»¬å­¦ä¼šäº†ï¼š

- âœ… ç†è§£ Ingress çš„ä½œç”¨å’Œæ¶æ„
- âœ… å¯ç”¨å’Œé…ç½® Ingress Controller
- âœ… åˆ›å»ºåŸºäºè·¯å¾„å’ŒåŸŸåçš„è·¯ç”±è§„åˆ™
- âœ… é…ç½® HTTPS å’Œ TLS è¯ä¹¦
- âœ… ä½¿ç”¨ Ingress é«˜çº§åŠŸèƒ½
- âœ… é€‰æ‹©åˆé€‚çš„ Ingress Controller

Ingress æ˜¯ Kubernetes é›†ç¾¤çš„æµé‡å…¥å£ï¼Œä¸ºå¾®æœåŠ¡æä¾›äº†ç»Ÿä¸€çš„è®¿é—®ç½‘å…³å’Œè·¯ç”±ç®¡ç†èƒ½åŠ›ã€‚

## 7. é…ç½®ç®¡ç†ï¼ˆNamespaceã€ConfigMapã€Secretï¼‰

åœ¨å®é™…é¡¹ç›®ä¸­ï¼Œæˆ‘ä»¬éœ€è¦ç®¡ç†ä¸åŒç¯å¢ƒçš„é…ç½®ã€æ•æ„Ÿä¿¡æ¯å’Œèµ„æºéš”ç¦»ã€‚Kubernetes æä¾›äº† Namespaceã€ConfigMap å’Œ Secret æ¥è§£å†³è¿™äº›é—®é¢˜ã€‚

### 7.1 Namespaceï¼ˆå‘½åç©ºé—´ï¼‰

Namespace æä¾›äº†èµ„æºéš”ç¦»æœºåˆ¶ï¼Œå¯ä»¥åœ¨åŒä¸€é›†ç¾¤ä¸­åˆ›å»ºå¤šä¸ªè™šæ‹Ÿé›†ç¾¤ã€‚

```mermaid
graph TB
    subgraph "Kubernetes é›†ç¾¤"
        subgraph "default namespace"
            A[hellok8s-pod]
            B[nginx-pod]
        end

        subgraph "dev namespace"
            C[hellok8s-dev-pod]
            D[mysql-dev-pod]
        end

        subgraph "prod namespace"
            E[hellok8s-prod-pod]
            F[mysql-prod-pod]
        end

        subgraph "kube-system namespace"
            G[coredns]
            H[kube-proxy]
        end
    end
```

**åˆ›å»º Namespaceï¼š**

#### namespaces.yaml

```yaml
apiVersion: v1
kind: Namespace
metadata:
  name: dev

---
apiVersion: v1
kind: Namespace
metadata:
  name: test
```

```bash
kubectl apply -f namespaces.yaml

kubectl get namespaces
# NAME              STATUS   AGE
# default           Active   215d
# dev               Active   2m44s
# test              Active   2m44s
# kube-system       Active   215d
# kube-public       Active   215d
```

**åœ¨æŒ‡å®š Namespace ä¸­æ“ä½œï¼š**

```bash
# åœ¨ dev namespace ä¸­åˆ›å»ºèµ„æº
kubectl apply -f deployment.yaml -n dev

# æŸ¥çœ‹æŒ‡å®š namespace çš„èµ„æº
kubectl get pods -n dev

# åˆ‡æ¢é»˜è®¤ namespace
kubectl config set-context --current --namespace=dev
```

### 7.2 ConfigMapï¼ˆé…ç½®æ˜ å°„ï¼‰

ConfigMap ç”¨äºå­˜å‚¨éæ•æ„Ÿçš„é…ç½®æ•°æ®ï¼Œå°†é…ç½®ä¸åº”ç”¨ä»£ç åˆ†ç¦»ã€‚

**åº”ç”¨ç¤ºä¾‹ï¼ˆv4 ç‰ˆæœ¬ï¼‰ï¼š**

```go
package main

import (
 "fmt"
 "io"
 "net/http"
 "os"
)

func hello(w http.ResponseWriter, r *http.Request) {
 host, _ := os.Hostname()
 dbURL := os.Getenv("DB_URL")
 io.WriteString(w, fmt.Sprintf("[v4] Hello, Kubernetes! From host: %s, Get Database Connect URL: %s", host, dbURL))
}

func main() {
 http.HandleFunc("/", hello)
 http.ListenAndServe(":3000", nil)
}
```

**åˆ›å»ºä¸åŒç¯å¢ƒçš„ ConfigMapï¼š**

#### hellok8s-config-dev.yaml

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: hellok8s-config
data:
  DB_URL: 'http://DB_ADDRESS_DEV'
  LOG_LEVEL: 'debug'
  CACHE_SIZE: '100'
```

#### hellok8s-config-prod.yaml

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: hellok8s-config
data:
  DB_URL: 'http://DB_ADDRESS_PROD'
  LOG_LEVEL: 'info'
  CACHE_SIZE: '1000'
```

**åœ¨ Pod ä¸­ä½¿ç”¨ ConfigMapï¼š**

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: hellok8s-pod
spec:
  containers:
    - name: hellok8s-container
      image: guangzhengli/hellok8s:v4
      env:
        - name: DB_URL
          valueFrom:
            configMapKeyRef:
              name: hellok8s-config
              key: DB_URL
        - name: LOG_LEVEL
          valueFrom:
            configMapKeyRef:
              name: hellok8s-config
              key: LOG_LEVEL
```

**éƒ¨ç½²å’Œæµ‹è¯•ï¼š**

```bash
# åœ¨ä¸åŒ namespace åˆ›å»ºä¸åŒé…ç½®
kubectl apply -f hellok8s-config-dev.yaml -n dev
kubectl apply -f hellok8s-config-prod.yaml -n prod

# éƒ¨ç½²åº”ç”¨
kubectl apply -f hellok8s.yaml -n dev
kubectl apply -f hellok8s.yaml -n prod

# æµ‹è¯•ä¸åŒç¯å¢ƒçš„é…ç½®
kubectl port-forward hellok8s-pod 3000:3000 -n dev
curl http://localhost:3000
# [v4] Hello, Kubernetes! From host: hellok8s-pod, Get Database Connect URL: http://DB_ADDRESS_DEV

kubectl port-forward hellok8s-pod 3000:3000 -n prod
curl http://localhost:3000
# [v4] Hello, Kubernetes! From host: hellok8s-pod, Get Database Connect URL: http://DB_ADDRESS_PROD
```

### 7.3 Secretï¼ˆå¯†é’¥ç®¡ç†ï¼‰

Secret ç”¨äºå­˜å‚¨æ•æ„Ÿä¿¡æ¯ï¼Œå¦‚å¯†ç ã€ä»¤ç‰Œã€å¯†é’¥ç­‰ã€‚

```mermaid
graph LR
    subgraph "ConfigMap vs Secret"
        A[ConfigMap] --> A1[éæ•æ„Ÿé…ç½®<br/>æ˜æ–‡å­˜å‚¨]
        B[Secret] --> B1[æ•æ„Ÿä¿¡æ¯<br/>Base64ç¼–ç ]
    end

    subgraph "Secret ç±»å‹"
        C[Opaque] --> C1[é€šç”¨å¯†é’¥]
        D[kubernetes.io/tls] --> D1[TLS è¯ä¹¦]
        E[kubernetes.io/dockerconfigjson] --> E1[Docker é•œåƒæ‹‰å–]
    end
```

**åˆ›å»º Secretï¼š**

#### æ–¹æ³• 1ï¼šå‘½ä»¤è¡Œåˆ›å»º

```bash
# åˆ›å»ºé€šç”¨ Secret
kubectl create secret generic hellok8s-secret \
  --from-literal=DB_PASSWORD=my-secret-password \
  --from-literal=API_KEY=abc123def456

# åˆ›å»º TLS Secret
kubectl create secret tls my-tls-secret \
  --cert=path/to/cert/file \
  --key=path/to/key/file
```

#### æ–¹æ³• 2ï¼šYAML æ–‡ä»¶åˆ›å»º

```yaml
apiVersion: v1
kind: Secret
metadata:
  name: hellok8s-secret
type: Opaque
data:
  DB_PASSWORD: bXktc2VjcmV0LXBhc3N3b3Jk # base64 ç¼–ç 
  API_KEY: YWJjMTIzZGVmNDU2 # base64 ç¼–ç 
```

**Base64 ç¼–ç /è§£ç ï¼š**

```bash
# ç¼–ç 
echo "my-secret-password" | base64
# bXktc2VjcmV0LXBhc3N3b3JkCg==

# è§£ç 
echo "bXktc2VjcmV0LXBhc3N3b3JkCg==" | base64 -d
# my-secret-password
```

**åœ¨åº”ç”¨ä¸­ä½¿ç”¨ Secretï¼š**

**åº”ç”¨ä»£ç ï¼ˆv5 ç‰ˆæœ¬ï¼‰ï¼š**

```go
package main

import (
 "fmt"
 "io"
 "net/http"
 "os"
)

func hello(w http.ResponseWriter, r *http.Request) {
 host, _ := os.Hostname()
 dbPassword := os.Getenv("DB_PASSWORD")
 apiKey := os.Getenv("API_KEY")
 io.WriteString(w, fmt.Sprintf("[v5] Hello, Kubernetes! From host: %s, DB Password: %s, API Key: %s", host, dbPassword, apiKey))
}

func main() {
 http.HandleFunc("/", hello)
 http.ListenAndServe(":3000", nil)
}
```

**Pod é…ç½®ï¼š**

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: hellok8s-pod
spec:
  containers:
    - name: hellok8s-container
      image: guangzhengli/hellok8s:v5
      env:
        - name: DB_PASSWORD
          valueFrom:
            secretKeyRef:
              name: hellok8s-secret
              key: DB_PASSWORD
        - name: API_KEY
          valueFrom:
            secretKeyRef:
              name: hellok8s-secret
              key: API_KEY
```

### 7.4 é…ç½®ç®¡ç†æœ€ä½³å®è·µ

```mermaid
graph TD
    A[é…ç½®ç®¡ç†æœ€ä½³å®è·µ] --> B[ç¯å¢ƒéš”ç¦»]
    A --> C[å®‰å…¨ç®¡ç†]
    A --> D[ç‰ˆæœ¬æ§åˆ¶]
    A --> E[è‡ªåŠ¨åŒ–éƒ¨ç½²]

    B --> B1[ä½¿ç”¨ Namespace åˆ†ç¦»ç¯å¢ƒ]
    B --> B2[ä¸åŒç¯å¢ƒä¸åŒé…ç½®]

    C --> C1[æ•æ„Ÿä¿¡æ¯ç”¨ Secret]
    C --> C2[æœ€å°æƒé™åŸåˆ™]
    C --> C3[å®šæœŸè½®æ¢å¯†é’¥]

    D --> D1[é…ç½®æ–‡ä»¶ç‰ˆæœ¬åŒ–]
    D --> D2[å˜æ›´è®°å½•è¿½è¸ª]

    E --> E1[CI/CD é›†æˆ]
    E --> E2[é…ç½®éªŒè¯]
```

**æ¨èçš„ç›®å½•ç»“æ„ï¼š**

```text
k8s-configs/
â”œâ”€â”€ base/
â”‚   â”œâ”€â”€ deployment.yaml
â”‚   â”œâ”€â”€ service.yaml
â”‚   â””â”€â”€ configmap.yaml
â”œâ”€â”€ environments/
â”‚   â”œâ”€â”€ dev/
â”‚   â”‚   â”œâ”€â”€ namespace.yaml
â”‚   â”‚   â”œâ”€â”€ configmap-dev.yaml
â”‚   â”‚   â””â”€â”€ secret-dev.yaml
â”‚   â”œâ”€â”€ test/
â”‚   â”‚   â”œâ”€â”€ namespace.yaml
â”‚   â”‚   â”œâ”€â”€ configmap-test.yaml
â”‚   â”‚   â””â”€â”€ secret-test.yaml
â”‚   â””â”€â”€ prod/
â”‚       â”œâ”€â”€ namespace.yaml
â”‚       â”œâ”€â”€ configmap-prod.yaml
â”‚       â””â”€â”€ secret-prod.yaml
```

## 8. Job å’Œ CronJobï¼ˆä»»åŠ¡ç®¡ç†ï¼‰

å¯¹äºä¸€æ¬¡æ€§ä»»åŠ¡å’Œå®šæ—¶ä»»åŠ¡ï¼ŒKubernetes æä¾›äº† Job å’Œ CronJob èµ„æºã€‚

### 8.1 Jobï¼ˆä¸€æ¬¡æ€§ä»»åŠ¡ï¼‰

```mermaid
graph LR
    A[Job åˆ›å»º] --> B[Pod å¯åŠ¨]
    B --> C{ä»»åŠ¡æ‰§è¡Œ}
    C -->|æˆåŠŸ| D[Job å®Œæˆ]
    C -->|å¤±è´¥| E[é‡è¯•æ‰§è¡Œ]
    E --> B
    D --> F[Pod ä¿ç•™<br/>å¯æŸ¥çœ‹æ—¥å¿—]
```

#### hello-job.yaml

```yaml
apiVersion: batch/v1
kind: Job
metadata:
  name: hello-job
spec:
  parallelism: 3 # å¹¶å‘æ‰§è¡Œæ•°
  completions: 5 # æ€»å®Œæˆæ•°
  template:
    spec:
      restartPolicy: OnFailure
      containers:
        - name: echo
          image: busybox
          command:
            - '/bin/sh'
          args:
            - '-c'
            - 'for i in 9 8 7 6 5 4 3 2 1 ; do echo $i ; done'
```

```bash
kubectl apply -f hello-job.yaml

kubectl get jobs
# NAME        COMPLETIONS   DURATION   AGE
# hello-job   5/5           19s        83s

kubectl get pods
# NAME              READY   STATUS      RESTARTS   AGE
# hello-job--1-xxx   0/1     Completed   0          34s
```

### 8.2 CronJobï¼ˆå®šæ—¶ä»»åŠ¡ï¼‰

#### hello-cronjob.yaml

```yaml
apiVersion: batch/v1
kind: CronJob
metadata:
  name: hello-cronjob
spec:
  schedule: '*/1 * * * *' # æ¯åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡
  jobTemplate:
    spec:
      template:
        spec:
          restartPolicy: OnFailure
          containers:
            - name: echo
              image: busybox
              command:
                - '/bin/sh'
              args:
                - '-c'
                - 'date; echo Hello from Kubernetes CronJob'
```

**Cron è¡¨è¾¾å¼è¯´æ˜ï¼š**

```text
# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ åˆ†é’Ÿ (0 - 59)
# â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ å°æ—¶ (0 - 23)
# â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ æ—¥ (1 - 31)
# â”‚ â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ æœˆ (1 - 12)
# â”‚ â”‚ â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ æ˜ŸæœŸ (0 - 6ï¼Œ0=å‘¨æ—¥)
# â”‚ â”‚ â”‚ â”‚ â”‚
# * * * * *

# å¸¸ç”¨ç¤ºä¾‹ï¼š
# "0 2 * * *"     # æ¯å¤©å‡Œæ™¨2ç‚¹
# "0 */6 * * *"   # æ¯6å°æ—¶
# "0 0 1 * *"     # æ¯æœˆ1å·
# "0 0 * * 1"     # æ¯å‘¨ä¸€
```

## 9. Helmï¼ˆåŒ…ç®¡ç†å™¨ï¼‰

Helm æ˜¯ Kubernetes çš„åŒ…ç®¡ç†å™¨ï¼Œç®€åŒ–äº†å¤æ‚åº”ç”¨çš„éƒ¨ç½²å’Œç®¡ç†ã€‚

### 9.1 å®‰è£… Helm

```bash
# macOS
brew install helm

# éªŒè¯å®‰è£…
helm version
```

### 9.2 ä½¿ç”¨ Helm Chart

**å¿«é€Ÿä½“éªŒï¼š**

```bash
# æ·»åŠ å®˜æ–¹ä»“åº“
helm repo add stable https://charts.helm.sh/stable
helm repo update

# æœç´¢ Chart
helm search repo nginx

# å®‰è£…åº”ç”¨
helm install my-nginx stable/nginx-ingress

# æŸ¥çœ‹å·²å®‰è£…çš„åº”ç”¨
helm list

# å¸è½½åº”ç”¨
helm uninstall my-nginx
```

### 9.3 åˆ›å»ºè‡ªå®šä¹‰ Chart

```bash
# åˆ›å»º Chart æ¨¡æ¿
helm create hellok8s-chart

# Chart ç›®å½•ç»“æ„
hellok8s-chart/
â”œâ”€â”€ Chart.yaml          # Chart å…ƒä¿¡æ¯
â”œâ”€â”€ values.yaml         # é»˜è®¤é…ç½®å€¼
â”œâ”€â”€ templates/          # æ¨¡æ¿æ–‡ä»¶
â”‚   â”œâ”€â”€ deployment.yaml
â”‚   â”œâ”€â”€ service.yaml
â”‚   â””â”€â”€ ingress.yaml
â””â”€â”€ charts/            # ä¾èµ– Chart
```

**ç®€åŒ–çš„ values.yamlï¼š**

```yaml
image:
  repository: guangzhengli/hellok8s
  tag: v3
  pullPolicy: IfNotPresent

service:
  type: ClusterIP
  port: 3000

ingress:
  enabled: true
  host: hello.k8s.local

replicaCount: 3

env:
  DB_URL: 'http://localhost:5432'
```

**éƒ¨ç½²å’Œç®¡ç†ï¼š**

```bash
# å®‰è£… Chart
helm install hellok8s ./hellok8s-chart

# å‡çº§åº”ç”¨
helm upgrade hellok8s ./hellok8s-chart --set replicaCount=5

# å›æ»šç‰ˆæœ¬
helm rollback hellok8s 1

# æŸ¥çœ‹å†å²
helm history hellok8s
```

## 10. æ€»ç»“ä¸æœ€ä½³å®è·µ

é€šè¿‡æœ¬å®è·µæ•™ç¨‹ï¼Œæˆ‘ä»¬å®Œæ•´åœ°å­¦ä¹ äº† Kubernetes çš„æ ¸å¿ƒæ¦‚å¿µå’Œå®é™…åº”ç”¨ï¼š

### 10.1 å­¦ä¹ è·¯å¾„æ€»ç»“

```mermaid
graph TD
    A[å®¹å™¨åŒ–åŸºç¡€] --> B[Pod ç®¡ç†]
    B --> C[Deployment è‡ªåŠ¨åŒ–]
    C --> D[Service ç½‘ç»œ]
    D --> E[Ingress ç½‘å…³]
    E --> F[é…ç½®ç®¡ç†]
    F --> G[ä»»åŠ¡è°ƒåº¦]
    G --> H[Helm åŒ…ç®¡ç†]

    A --> A1[Docker é•œåƒæ„å»º]
    B --> B1[æœ€å°éƒ¨ç½²å•å…ƒ]
    C --> C1[æ»šåŠ¨æ›´æ–°/æ‰©ç¼©å®¹]
    D --> D1[æœåŠ¡å‘ç°/è´Ÿè½½å‡è¡¡]
    E --> E1[æµé‡è·¯ç”±/SSLç»ˆç»“]
    F --> F1[ç¯å¢ƒéš”ç¦»/é…ç½®åˆ†ç¦»]
    G --> G1[æ‰¹å¤„ç†/å®šæ—¶ä»»åŠ¡]
    H --> H1[åº”ç”¨æ‰“åŒ…/ç‰ˆæœ¬ç®¡ç†]
```

### 10.2 ç”Ÿäº§ç¯å¢ƒæœ€ä½³å®è·µ

1. **èµ„æºç®¡ç†**

   - è®¾ç½®èµ„æºé™åˆ¶å’Œè¯·æ±‚
   - ä½¿ç”¨ HPA è‡ªåŠ¨æ‰©ç¼©å®¹
   - é…ç½®èŠ‚ç‚¹äº²å’Œæ€§

2. **å®‰å…¨é…ç½®**

   - å¯ç”¨ RBAC æƒé™æ§åˆ¶
   - ä½¿ç”¨ NetworkPolicy ç½‘ç»œéš”ç¦»
   - å®šæœŸæ›´æ–°é•œåƒå’Œé›†ç¾¤

3. **ç›‘æ§å‘Šè­¦**

   - éƒ¨ç½² Prometheus + Grafana
   - é…ç½®åº”ç”¨å’ŒåŸºç¡€è®¾æ–½ç›‘æ§
   - è®¾ç½®å…³é”®æŒ‡æ ‡å‘Šè­¦

4. **å¤‡ä»½æ¢å¤**
   - å®šæœŸå¤‡ä»½ etcd æ•°æ®
   - åˆ¶å®šç¾éš¾æ¢å¤è®¡åˆ’
   - æµ‹è¯•æ¢å¤æµç¨‹

### 10.3 è¿›é˜¶å­¦ä¹ æ–¹å‘

- **æœåŠ¡ç½‘æ ¼**ï¼šIstioã€Linkerd
- **CI/CD é›†æˆ**ï¼šGitOpsã€ArgoCD
- **å­˜å‚¨ç®¡ç†**ï¼šPVã€PVCã€StorageClass
- **é›†ç¾¤ç®¡ç†**ï¼šå¤šé›†ç¾¤ã€è”é‚¦
- **å®‰å…¨åŠ å›º**ï¼šPod Security Standardsã€OPA

é€šè¿‡è¿™ä¸ªå®è·µæ•™ç¨‹ï¼Œä½ å·²ç»æŒæ¡äº† Kubernetes çš„æ ¸å¿ƒæŠ€èƒ½ï¼Œå¯ä»¥å¼€å§‹åœ¨å®é™…é¡¹ç›®ä¸­åº”ç”¨è¿™äº›çŸ¥è¯†äº†ï¼

---

**å‚è€ƒèµ„æºï¼š**

- [Kubernetes å®˜æ–¹æ–‡æ¡£](https://kubernetes.io/docs/)
- [Helm å®˜æ–¹æ–‡æ¡£](https://helm.sh/docs/)
- [kubectl å‘½ä»¤å‚è€ƒ](https://kubernetes.io/docs/reference/kubectl/)
- [YAML é…ç½®ç¤ºä¾‹](https://github.com/kubernetes/examples)
